<!DOCTYPE html><html lang=en><head>
  <meta content="text/html; charset=utf-8" http-equiv=Content-Type>
  <title>CSS Ruby Layout Module Level 1</title>
  <link href=../default.css rel=stylesheet type=text/css>
  <link href=../csslogo.ico rel="shortcut icon" type=image/x-icon>
  <style>
  body {
    background: url("https://www.w3.org/StyleSheets/TR/logo-ED") top left no-repeat white;
    background-attachment: fixed;
    color: black;
    font-family: sans-serif;
    margin: 0 auto;
    max-width: 50em;
    padding: 2em 1em 2em 70px;
  }
  :link { color: #00C; background: transparent }
  :visited { color: #609; background: transparent }
  a[href]:active { color: #C00; background: transparent }
  a[href]:hover { background: #ffa }

  a[href] img { border-style: none }

  h1, h2, h3, h4, h5, h6 { text-align: left }
  h1, h2, h3 { color: #005A9C; }
  h1 { font: 170% sans-serif }
  h2 { font: 140% sans-serif }
  h3 { font: 120% sans-serif }
  h4 { font: bold 100% sans-serif }
  h5 { font: italic 100% sans-serif }
  h6 { font: small-caps 100% sans-serif }

  .hide { display: none }

  div.head { margin-bottom: 1em }
  div.head h1 { margin-top: 2em; clear: both }
  div.head table { margin-left: 2em; margin-top: 2em }

  p.copyright { font-size: small }
  p.copyright small { font-size: small }

  pre { margin-left: 2em }
  dt { font-weight: bold }

  ul.toc, ol.toc {
    list-style: none;
  }
  </style>
</head>
<body class=h-entry>
<div class=head>
  <p data-fill-with=logo><a class=logo href=http://www.w3.org/>
    <img alt=W3C height=48 src=https://www.w3.org/Icons/w3c_home width=72>
</a>
</p>
  <h1 class="p-name no-ref" id=title>CSS Ruby Layout Module Level 1</h1>
  <h2 class="no-num no-toc no-ref heading settled" id=subtitle><span class=content>Editor’s Draft,
    <span class=dt-updated><span class=value-title title=20141122>22 November 2014</span></span></span></h2>
  <div data-fill-with=spec-metadata><dl><dt>This version:<dd><a class=u-url href=http://dev.w3.org/csswg/css-ruby-1/>http://dev.w3.org/csswg/css-ruby-1/</a><dt>Latest version:<dd><a href=http://www.w3.org/TR/css-ruby-1/>http://www.w3.org/TR/css-ruby-1/</a><dt>Previous Versions:<dd><a href=http://www.w3.org/TR/2013/WD-css3-ruby-20130919/ rel=previous>http://www.w3.org/TR/2013/WD-css3-ruby-20130919/</a><dt>Feedback:<dd><span><a href="mailto:www-style@w3.org?subject=[css-ruby] feedback">www-style@w3.org</a> with subject line “<kbd>[css-ruby] <var>… message topic …</var></kbd>” (<a href=http://lists.w3.org/Archives/Public/www-style/ rel=discussion>archives</a>)</span><dt>Editors:<dd><div class="p-author h-card vcard"><a class="p-name fn u-url url" href=http://fantasai.inkedblade.net/contact>Elika J. Etemad</a> (<span class="p-org org">Invited Expert</span>)</div><dd><div class="p-author h-card vcard"><a class="p-name fn u-email email" href=mailto:kojiishi@gluesoft.co.jp>Koji Ishii</a> (<span class="p-org org">Invited Expert</span>)</div></dl></div>
  <div data-fill-with=warning></div>
  <p class=copyright data-fill-with=copyright><a href=http://www.w3.org/Consortium/Legal/ipr-notice#Copyright>Copyright</a> © 2014 <a href=http://www.w3.org/><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href=http://www.csail.mit.edu/><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href=http://www.ercim.eu/><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href=http://www.keio.ac.jp/>Keio</a>, <a href=http://ev.buaa.edu.cn/>Beihang</a>), All Rights Reserved. W3C <a href=http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer>liability</a>, <a href=http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks>trademark</a> and <a href=http://www.w3.org/Consortium/Legal/copyright-documents>document use</a> rules apply.
</p>
  <hr title="Separator for header">
</div>

<h2 class="no-num no-toc no-ref heading settled" id=abstract><span class=content>Abstract</span></h2>
<div class=p-summary data-fill-with=abstract><p>“Ruby”, a form of interlinear annotation, are short runs of text alongside the base text.

They are typically used in East Asian documents to indicate pronunciation or to provide a short annotation.
This module describes the rendering model and formatting controls related to displaying ruby annotations in CSS.</p>

<a href=http://www.w3.org/TR/CSS/>CSS</a> is a language for describing the rendering of structured documents 
(such as HTML and XML) 
on screen, on paper, in speech, etc.</div>

<h2 class="no-num no-toc no-ref heading settled" id=status><span class=content>Status of this document</span></h2>
<div data-fill-with=status><p>
	This is a public copy of the editors’ draft.
	It is provided for discussion only and may change at any moment.
	Its publication here does not imply endorsement of its contents by W3C.
	Don’t cite this document other than as work in progress.

<p>
	The (<a href=http://lists.w3.org/Archives/Public/www-style/>archived</a>) public mailing list
	<a href="mailto:www-style@w3.org?Subject=%5Bcss-ruby%5D%20PUT%20SUBJECT%20HERE">www-style@w3.org</a>
	(see <a href=http://www.w3.org/Mail/Request>instructions</a>)
	is preferred for discussion of this specification.
	When sending e-mail,
	please put the text “css-ruby” in the subject,
	preferably like this:
	“[css-ruby] <em>…summary of comment…</em>”

<p>
	This document was produced by the <a href=http://www.w3.org/Style/CSS/members>CSS Working Group</a>
	(part of the <a href=http://www.w3.org/Style/>Style Activity</a>).

<p>
	This document was produced by a group operating under
	the <a href=http://www.w3.org/Consortium/Patent-Policy-20040205/>5 February 2004 W3C Patent Policy</a>.
	W3C maintains a <a href=http://www.w3.org/2004/01/pp-impl/32061/status rel=disclosure>public list of any patent disclosures</a>
	made in connection with the deliverables of the group;
	that page also includes instructions for disclosing a patent.
	An individual who has actual knowledge of a patent which the individual believes contains <a href=http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential>Essential Claim(s)</a>
	must disclose the information in accordance with <a href=http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure>section 6 of the W3C Patent Policy</a>.

<p>
	This document is governed by the <a href=http://www.w3.org/2014/Process-20140801/>1 August 2014 W3C Process Document</a>.
</div>
<div data-fill-with=at-risk></div>

<h2 class="no-num no-toc no-ref heading settled" id=contents><span class=content>Table of Contents</span></h2>
<div data-fill-with=table-of-contents><ul class=toc><li><a href=#intro><span class=secno>1</span> <span class=content>
Introduction</span></a><ul class=toc><li><a href=#placement><span class=secno>1.1</span> <span class=content>
Module interactions</span></a><li><a href=#values><span class=secno>1.2</span> <span class=content>
Values</span></a><li><a href=#diagram-conventions><span class=secno>1.3</span> <span class=content>
Diagram conventions</span></a><li><a href=#ruby-def><span class=secno>1.4</span> <span class=content>
What is ruby?</span></a></ul><li><a href=#ruby-model><span class=secno>2</span> <span class=content>
Ruby Box Model</span></a><ul class=toc><li><a href=#ruby-display><span class=secno>2.1</span> <span class=content>
Ruby-specific <span class=property data-link-type=propdesc title=display>display</span> Values</span></a><ul class=toc><li><a href=#formatting-context><span class=secno>2.1.1</span> <span class=content>
The Ruby Formatting Context</span></a><li><a href=#display-inside-outside><span class=secno>2.1.2</span> <span class=content>
Ruby-specific <span class=property data-link-type=propdesc title=display-inside>display-inside</span> and <span class=property data-link-type=propdesc title=display-outside>display-outside</span> values</span></a><li><a href=#block-ruby><span class=secno>2.1.3</span> <span class=content>
Non-Inline Ruby</span></a></ul><li><a href=#box-fixup><span class=secno>2.2</span> <span class=content>
Anonymous Ruby Box Generation</span></a><li><a href=#ruby-pairing><span class=secno>2.3</span> <span class=content>
Annotation Pairing</span></a><ul class=toc><li><a href=#segment-pairing><span class=secno>2.3.1</span> <span class=content>
Segment Pairing and Annotation Levels</span></a><li><a href=#base-annotation-pairing><span class=secno>2.3.2</span> <span class=content>
Unit Pairing and Spanning Annotations</span></a><li><a href=#nested-pairing><span class=secno>2.3.3</span> <span class=content>
Complex Spanning with Nested Ruby</span></a></ul><li><a href=#autohide><span class=secno>2.4</span> <span class=content>
Autohiding Base-identical Annotations</span></a><li><a href=#white-space><span class=secno>2.5</span> <span class=content>
White Space Collapsing</span></a></ul><li><a href=#ruby-layout><span class=secno>3</span> <span class=content>
Ruby Layout</span></a><ul class=toc><li><a href=#inter-character-layout><span class=secno>3.1</span> <span class=content>
Inter-character Ruby Layout</span></a><li><a href=#box-style><span class=secno>3.2</span> <span class=content>
Styling Ruby Boxes</span></a><li><a href=#line-breaks><span class=secno>3.3</span> <span class=content>
Breaking Across Lines</span></a><ul class=toc><li><a href=#break-between><span class=secno>3.3.1</span> <span class=content>
Breaking Between Bases</span></a><li><a href=#break-within><span class=secno>3.3.2</span> <span class=content>
Breaking Within Bases</span></a></ul><li><a href=#bidi><span class=secno>3.4</span> <span class=content>
Bidi Reordering</span></a><li><a href=#line-height><span class=secno>3.5</span> <span class=content>
Line Spacing</span></a></ul><li><a href=#ruby-props><span class=secno>4</span> <span class=content>
Ruby Formatting Properties</span></a><ul class=toc><li><a href=#rubypos><span class=secno>4.1</span> <span class=content>
Ruby Positioning: the <span class=property data-link-type=propdesc title=ruby-position>ruby-position</span> property</span></a><li><a href=#collapsed-ruby><span class=secno>4.2</span> <span class=content>
Sharing Annotation Space: the <span class=property data-link-type=propdesc title=ruby-merge>ruby-merge</span> property</span></a><li><a href=#ruby-align-property><span class=secno>4.3</span> <span class=content><span></span>
Ruby Text Distribution: the <span class=property data-link-type=propdesc title=ruby-align>ruby-align</span> property</span></a></ul><li><a href=#edge-effects><span class=secno>5</span> <span class=content>
Edge Effects</span></a><ul class=toc><li><a href=#ruby-overhang><span class=secno>5.1</span> <span class=content>
Overhanging Ruby</span></a><li><a href=#line-edge><span class=secno>5.2</span> <span class=content>
Line-edge Alignment</span></a></ul><li><a href=#default-stylesheet><span class=secno></span> <span class=content>
Appendix A: Default Style Sheet</span></a><ul class=toc><li><a href=#default-ua-ruby><span class=secno></span> <span class=content>
<span class=secno>A.1</span> Supporting Ruby Layout</span></a><li><a href=#default-inline><span class=secno></span> <span class=content>
<span class=secno>A.2</span> Inlining Ruby Annotations</span></a><li><a href=#default-parens><span class=secno></span> <span class=content>
<span class=secno>A.3</span> Generating Parentheses</span></a></ul><li><a href=#glossary><span class=secno>6</span> <span class=content>
Glossary</span></a><li><a href=#acknowledgments><span class=secno></span> <span class=content>
Acknowledgments</span></a><li><a href=#changes><span class=secno></span> <span class=content>
Changes</span></a><li><a href=#conformance><span class=secno></span> <span class=content>
Conformance</span></a><ul class=toc><li><a href=#conventions><span class=secno></span> <span class=content>
Document conventions</span></a><li><a href=#conformance-classes><span class=secno></span> <span class=content>
Conformance classes</span></a><li><a href=#partial><span class=secno></span> <span class=content>
Partial implementations</span></a><li><a href=#experimental><span class=secno></span> <span class=content>
Experimental implementations</span></a><li><a href=#testing><span class=secno></span> <span class=content>
Non-experimental implementations</span></a></ul><li><a href=#references><span class=secno></span> <span class=content>References</span></a><ul class=toc><li><a href=#normative><span class=secno></span> <span class=content>Normative References</span></a><li><a href=#informative><span class=secno></span> <span class=content>Informative References</span></a></ul><li><a href=#index><span class=secno></span> <span class=content>Index</span></a><li><a href=#property-index><span class=secno></span> <span class=content>Property Index</span></a><li><a href=#issues-index><span class=secno></span> <span class=content>Issues Index</span></a></ul></div>




<p></p>

<h2 class="heading settled" data-level=1 id=intro><span class=secno>1. </span><span class=content>
Introduction</span><a class=self-link href=#intro></a></h2>

	<p><em>This section is not normative.</em>

<h3 class="heading settled" data-level=1.1 id=placement><span class=secno>1.1. </span><span class=content>
Module interactions</span><a class=self-link href=#placement></a></h3>

	<p>This module extends the inline box model of CSS Level 2 <a data-biblio-type=normative data-link-type=biblio href=#biblio-css21 title=CSS21>[CSS21]</a>
	to support ruby.

	<p>None of the properties in this module apply to the <code>::first-line</code> or
	<code>::first-letter</code> pseudo-elements.

<h3 class="heading settled" data-level=1.2 id=values><span class=secno>1.2. </span><span class=content>
Values</span><a class=self-link href=#values></a></h3>

	<p>This specification follows the
	<a href=http://www.w3.org/TR/CSS21/about.html#property-defs>CSS property
	definition conventions</a> from <a data-biblio-type=normative data-link-type=biblio href=#biblio-css21 title=CSS21>[CSS21]</a>. Value types not defined in
	this specification are defined in CSS Level 2 Revision 1 <a data-biblio-type=normative data-link-type=biblio href=#biblio-css21 title=CSS21>[CSS21]</a>.
	Other CSS modules may expand the definitions of these value types: for
	example <a data-biblio-type=informative data-link-type=biblio href=#biblio-css3val title=CSS3VAL>[CSS3VAL]</a>, when combined with this module, expands the
	definition of the <var>&lt;length&gt;</var> value type as used in this specification.</p>

	<p>In addition to the property-specific values listed in their definitions,
	all properties defined in this specification also accept the
	<a href=http://www.w3.org/TR/CSS21/cascade.html#value-def-inherit>inherit</a>
	keyword as their property value. For readability it has not been repeated
	explicitly.

<h3 class="heading settled" data-level=1.3 id=diagram-conventions><span class=secno>1.3. </span><span class=content>
Diagram conventions</span><a class=self-link href=#diagram-conventions></a></h3>

	<p>Many typographical conventions in East Asian typography depend
	on whether the character rendered is wide (CJK) or narrow (non-CJK).
	There are a number of illustrations in this document
	for which the following legend is used:

	<dl>
		<dt><img alt="Symbolic wide-cell glyph representation" height=39 src=images/fullwidth.gif width=39>
		<dd>Wide-cell glyph (e.g. Han) that is the <var>n</var>th character in the text run.
		They are typically sized to 50% when used as annotations.
		<dt><img alt="Symbolic narrow-cell glyph representation" height=39 src=images/halfwidth.gif width=19>
		<dd>Narrow-cell glyph (e.g. Roman) which is the <var>n</var>th glyph in the text run.
	</dl>

	<p>The orientation which the above symbols assume in the diagrams
	corresponds to the orientation that the glyphs they represent
	are intended to assume when rendered by the user agent.
	Spacing between these characters in the diagrams is incidental,
	unless intentionally changed to make a point.

<h3 class="heading settled" data-level=1.4 id=ruby-def><span class=secno>1.4. </span><span class=content>
What is ruby?</span><a class=self-link href=#ruby-def></a></h3>

	<p><dfn data-dfn-type=dfn data-noexport="" id=ruby>Ruby<a class=self-link href=#ruby></a></dfn> is the commonly-used name for a run of text
	that appears alongside another run of text (referred to as the “base”)
	and serves as an annotation or a pronunciation guide associated with that run of text.

	<p>The following figures show two examples of Ruby,
	a simple case and one with more complicated structure.

	<div class=example>
		<p>In this first example, a single annotation is used to annotate the base text.
		<div class=figure>
			<p><img alt="Example of ruby applied on top of a Japanese expression" src=images/licence.png>
			<p class=caption>Example of ruby used in Japanese (simple case)
		</div>
		<p>In Japanese typography, this case is sometimes called
		<span lang=ja>taigo</span> ruby or group-ruby (per-word ruby),
		because the annotation as a whole is associated
		with multi-character word (as a whole).
	</div>

	<div class=example>
		<p>In this second example,
		two levels of annotations are attached to a base sequence:
		the hiragana characters on top refer to the pronunciation of each of the base kanji characters,
		while the words “Keio” and “University” on the bottom are annotations describing the English translation.
		<div class=figure>
			<p><img alt="Example showing complex ruby with annotation text over and under the base characters" src=images/ruby-univ.gif>
			<p class=caption>Complex ruby with annotation text over and under the base characters
		</div>
		<p>
		<p>Notice that to allow correct association between the hiragana characters and 
		their corresponding Kanji base characters,
		the spacing between these Kanji characters is adjusted.
		(This happens around the fourth Kanji character in the figure above.)
		To avoid variable spacing between the Kanji characters in the example above
		the hiragana annotations can be styled as a <a data-link-type=dfn href=#collapsed-annotation title="collapsed annotation">collapsed annotation</a>,
		which will look more like the group-ruby example earlier.
		However because the base-annotation pairings are recorded in the ruby structure,
		if the text breaks across lines, the annotation characters will stay
		correctly paired with their respective base characters.
	</div>

	<p><a data-link-type=dfn href=#ruby title=Ruby>Ruby</a> formatting as used in Japanese is described in JIS X-4051 <a data-biblio-type=informative data-link-type=biblio href=#biblio-jis4051 title=JIS4051>[JIS4051]</a> (in Japanese)
	and in Requirements for Japanese Text Layout <a data-biblio-type=informative data-link-type=biblio href=#biblio-jlreq title=JLREQ>[JLREQ]</a> (in English and Japanese)].
	In HTML, ruby structure and markup to represent it is described
	in the Ruby Markup Extension specification.
	This module describes the CSS rendering model
	and formatting controls relevant to ruby layout of such markup.

<h2 class="heading settled" data-level=2 id=ruby-model><span class=secno>2. </span><span class=content>
Ruby Box Model</span><a class=self-link href=#ruby-model></a></h2>

	<p>The CSS ruby model is based on
	the <a href=http://www.w3.org/TR/html5/text-level-semantics.html#the-ruby-element>W3C HTML5 Ruby Markup</a> model
	and the <a href=http://www.w3.org/TR/ruby/>XHTML Ruby Annotation Recommendation</a> <a data-biblio-type=informative data-link-type=biblio href=#biblio-ruby title=RUBY>[RUBY]</a>.
	In this model, a ruby structure consists of
	one or more <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> elements representing the base (annotated) text,
	associated with one or more levels of <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> elements representing the annotations.
	The structure of ruby is similar to that of a table:
	there are “rows” (the <a data-link-type=dfn href=#base-level title="base level">base text level</a>, each <a data-link-type=dfn href=#annotation-level title="annotation level">annotation level</a>)
	and “columns” (each <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> and its corresponding <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>).

	<p>Consecutive bases and annotations are grouped together into <a data-link-type=dfn href=#ruby-segments title="ruby segments">ruby segments</a>.
	Within a <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a>, a <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> may span multiple <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.

	<p class=note>In HTML, a single <code>&lt;ruby&gt;</code> element may contain multiple <a data-link-type=dfn href=#ruby-segments title="ruby segments">ruby segments</a>.
	(In the XHTML Ruby model, a single <code>&lt;ruby&gt;</code> element can only contain one <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a>.)

<h3 class="heading settled" data-level=2.1 id=ruby-display><span class=secno>2.1. </span><span class=content>
Ruby-specific <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> Values</span><a class=self-link href=#ruby-display></a></h3>

	<p>For document languages (such as XML applications) that do not have pre-defined ruby elements,
	authors must map document language elements to ruby elements;
	this is done with the <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> property.

	<table class=propdef>
		<tr>
			<th>Name:
			<td><dfn class=css data-dfn-type=property data-export="" id=propdef-display>display<a class=self-link href=#propdef-display></a></dfn><tr>
			<th><a href=#values>New Values</a>:
			<td>ruby | ruby-base | ruby-text | ruby-base-container | ruby-text-container
	</table>

	<p>The following new <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> values assign ruby layout roles to an arbitrary element:

	<dl data-dfn-for=display data-dfn-type=value data-export="">
		<dt><dfn class=css data-dfn-for=display data-dfn-type=value data-export="" id=valdef-display-ruby><a class=css data-link-type=maybe href=#valdef-display-ruby title=ruby>ruby</a><a class=self-link href=#valdef-display-ruby></a></dfn>
			<dd>Specifies that an element generates a <dfn data-dfn-for="" data-dfn-type=dfn data-export="" id=ruby-container title="ruby container | ruby container box">ruby container box<a class=self-link href=#ruby-container></a></dfn>.
			(Corresponds to HTML/XHTML <code>&lt;ruby&gt;</code> elements.)
		<dt><dfn class=css data-dfn-for=display data-dfn-type=value data-export="" id=valdef-display-ruby-base><a class=css data-link-type=maybe href=#valdef-display-ruby-base title=ruby-base>ruby-base</a><a class=self-link href=#valdef-display-ruby-base></a></dfn>
			<dd>Specifies that an element generates a <dfn data-dfn-for="" data-dfn-type=dfn data-export="" id=ruby-base-box title="ruby base box | ruby base">ruby base box<a class=self-link href=#ruby-base-box></a></dfn>.
			(Corresponds to HTML/XHTML <code>&lt;rb&gt;</code> elements.)
		<dt><dfn class=css data-dfn-for=display data-dfn-type=value data-export="" id=valdef-display-ruby-text><a class=css data-link-type=maybe href=#valdef-display-ruby-text title=ruby-text>ruby-text</a><a class=self-link href=#valdef-display-ruby-text></a></dfn>
			<dd>Specifies that an element generates a <dfn data-dfn-for="" data-dfn-type=dfn data-export="" id=ruby-annotation-box title="ruby annotation box | ruby annotation | annotation">ruby annotation box<a class=self-link href=#ruby-annotation-box></a></dfn>.
			(Corresponds to HTML/XHTML <code>&lt;rt&gt;</code> elements.)
		<dt><dfn class=css data-dfn-for=display data-dfn-type=value data-export="" id=valdef-display-ruby-base-container><a class=css data-link-type=maybe href=#valdef-display-ruby-base-container title=ruby-base-container>ruby-base-container</a><a class=self-link href=#valdef-display-ruby-base-container></a></dfn>
			<dd>Specifies that an element generates a <dfn data-dfn-for="" data-dfn-type=dfn data-export="" id=ruby-base-container-box title="ruby base container box | ruby base container">ruby base container box<a class=self-link href=#ruby-base-container-box></a></dfn>.
			(Corresponds to XHTML <code>&lt;rbc&gt;</code> elements; generated as an anonymous box in HTML.)
		<dt><dfn class=css data-dfn-for=display data-dfn-type=value data-export="" id=valdef-display-ruby-text-container><a class=css data-link-type=maybe href=#valdef-display-ruby-text-container title=ruby-text-container>ruby-text-container</a><a class=self-link href=#valdef-display-ruby-text-container></a></dfn>
			<dd>Specifies that an element generates a <dfn data-dfn-for="" data-dfn-type=dfn data-export="" id=ruby-annotation-container-box title="ruby annotation container box | ruby annotation container">ruby annotation container box<a class=self-link href=#ruby-annotation-container-box></a></dfn>.
			(Corresponds to HTML/XHTML <code>&lt;rtc&gt;</code> elements.)
	</dl>

	<p class=advisement>Authors using a language (such as HTML)
	that supports dedicated ruby markup
	should use that markup rather than
	styling arbitrary elements (like <code>&lt;span&gt;</code>)
	with ruby <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> values.
	Using the correct markup ensures that screen readers
	and non-CSS renderers can interpret the ruby structures.

<h4 class="heading settled" data-level=2.1.1 id=formatting-context><span class=secno>2.1.1. </span><span class=content>
The Ruby Formatting Context</span><a class=self-link href=#formatting-context></a></h4>

	<p><a data-link-type=dfn href=#ruby-container title="Ruby containers">Ruby containers</a> are non-atomic inline-level boxes.
	Like inline boxes, they break across lines,
	and their containing block is the nearest block container ancestor.
	And just as the contents of an inline box
	participate in the same inline formatting context that contains the inline box itself,
	a <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> and its base-level contents
	participate in the same inline formatting context that contains the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> itself.

	<p>However <a data-link-type=dfn href=#ruby-container title="ruby containers">ruby containers</a> also establish a <dfn data-dfn-type=dfn data-noexport="" id=ruby-formatting-context>ruby formatting context<a class=self-link href=#ruby-formatting-context></a></dfn>
	that builds further structure around their segment of the inline formatting context.
	<a data-link-type=dfn href=#ruby-base-box title="Ruby bases">Ruby bases</a>, <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>, <a data-link-type=dfn href=#ruby-base-container-box title="ruby base containers">ruby base containers</a>, and <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a>
	are <dfn data-dfn-type=dfn data-noexport="" id=internal-ruby-boxes title="internal ruby boxes|internal ruby display types">internal ruby boxes<a class=self-link href=#internal-ruby-boxes></a></dfn>:
	like <i data-link-type=dfn title="internal table elements">internal table elements</i>,
	they have specific roles in ruby layout,
	and participate in their <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>’s <a data-link-type=dfn href=#ruby-formatting-context title="ruby formatting context">ruby formatting context</a>.

	<p>As with the contents of inline boxes,
	the containing block for the contents of a <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> (and all its <a data-link-type=dfn href=#internal-ruby-boxes title="internal ruby boxes">internal ruby boxes</a>)
	is the containing block of the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>.
	So floats, for example, are trapped by the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>’s containing block,
	not any of the ruby box types.

	<p class=issue id=issue-ca88244c><a class=self-link href=#issue-ca88244c></a>Are internal ruby boxes inline-level?

<h4 class="heading settled" data-level=2.1.2 id=display-inside-outside><span class=secno>2.1.2. </span><span class=content>
Ruby-specific <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-inside title=display-inside>display-inside</a> and <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-outside title=display-outside>display-outside</a> values</span><a class=self-link href=#display-inside-outside></a></h4>

	<p>The ruby-specific <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> values map to <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-inside title=display-inside>display-inside</a> and <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-outside title=display-outside>display-outside</a> as follows:
	<table class=data>
	<thead>
		<tr><th><a class=property data-link-type=propdesc href=#propdef-display title=display>display</a>
		    <th><a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-outside title=display-outside>display-outside</a>
		    <th><a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-inside title=display-inside>display-inside</a>
	<tbody>
		<tr><td><a class=css data-link-type=maybe href=#valdef-display-ruby title=ruby>ruby</a>
		    <td><span class=css>inline-level</span>
		    <td><a class=css data-link-type=maybe href=#valdef-display-ruby title=ruby>ruby</a>
		<tr><td><a class=css data-link-type=maybe href=#valdef-display-ruby-base title=ruby-base>ruby-base</a>
		    <td><a class=css data-link-type=maybe href=#valdef-display-ruby-base title=ruby-base>ruby-base</a>
		    <td><span class=css>auto</span>
		<tr><td><a class=css data-link-type=maybe href=#valdef-display-ruby-text title=ruby-text>ruby-text</a>
		    <td><a class=css data-link-type=maybe href=#valdef-display-ruby-text title=ruby-text>ruby-text</a>
		    <td><span class=css>auto</span>
		<tr><td><a class=css data-link-type=maybe href=#valdef-display-ruby-base-container title=ruby-base-container>ruby-base-container</a>
		    <td><a class=css data-link-type=maybe href=#valdef-display-ruby-base-container title=ruby-base-container>ruby-base-container</a>
		    <td><span class=css>auto</span>
		<tr><td><a class=css data-link-type=maybe href=#valdef-display-ruby-text-container title=ruby-text-container>ruby-text-container</a>
		    <td><a class=css data-link-type=maybe href=#valdef-display-ruby-text-container title=ruby-text-container>ruby-text-container</a>
		    <td><span class=css>auto</span>
	</table>

	<p>See the <a href=http://www.w3.org/TR/css-display/>CSS Display Module</a>
	for more information on <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-inside title=display-inside>display-inside</a> and <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-outside title=display-outside>display-outside</a>. <a data-biblio-type=normative data-link-type=biblio href=#biblio-css3-display title=CSS3-DISPLAY>[CSS3-DISPLAY]</a>

<h4 class="heading settled" data-level=2.1.3 id=block-ruby><span class=secno>2.1.3. </span><span class=content>
Non-Inline Ruby</span><a class=self-link href=#block-ruby></a></h4>

	<p>If an element has a computed <a data-link-type=dfn href=http://dev.w3.org/csswg/css-display-3/#inner-display-type title="inner display type">inner display type</a> of <a class=css data-link-type=maybe href=#valdef-display-ruby title=ruby>ruby</a>
	and a computed computed <a data-link-type=dfn href=http://dev.w3.org/csswg/css-display-3/#outer-display-type title="outer display type">outer display type</a> other than <span class=css>inline-level</span>,
	then it generates two boxes:
	a principal block container box of the required <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-display-3/#propdef-display-outside title=display-outside>display-outside</a> type,
	and an inline-level <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>.
	All properties specified on the element apply to the principal box
	(and if inheritable, inherit to the <a data-link-type=dfn href=#ruby-container title="ruby container box">ruby container box</a>).
	This allows styling the element as a block,
	while correctly maintaining the internal ruby structure.

	<p class=note>
	Note: There is no dedicated block-level <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> shorthand keyword
	because ruby is fundamentally an inline layout feature.

	<p class=note>
	Note that absolute positioning or floating an element causes its <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> value
	to compute to a block-level equivalent. (See <a data-biblio-type=normative data-link-type=biblio href=#biblio-css3-display title=CSS3-DISPLAY>[CSS3-DISPLAY]</a> or <a data-biblio-type=normative data-link-type=biblio href=#biblio-css21 title=CSS21>[CSS21]</a> section 9.7.)
	For the <a data-link-type=dfn href=#internal-ruby-boxes title="internal ruby display types">internal ruby display types</a>,
	this causes their <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> value to compute to <span class=css>block</span>.

<h3 class="heading settled" data-level=2.2 id=box-fixup><span class=secno>2.2. </span><span class=content>
Anonymous Ruby Box Generation</span><a class=self-link href=#box-fixup></a></h3>

	<p>The CSS model does not require that the document language
	include elements that correspond to each of these components.
	Missing parts of the structure are implied through the anonymous box generation rules
	<a href=http://www.w3.org/TR/CSS21/tables.html#anonymous-boxes>similar to those used to normalize tables</a>. <a data-biblio-type=normative data-link-type=biblio href=#biblio-css21 title=CSS21>[CSS21]</a>

	<ol>
		<li id=anon-gen-anon-ruby><a class=self-link href=#anon-gen-anon-ruby></a><strong>Generate anonymous ruby containers</strong>:
			Any <a href=http://www.w3.org/TR/CSS21/tables.html#anonymous-boxes>consecutive</a> sequence of
			improperly-contained
			<a data-link-type=dfn href=#ruby-base-container-box title="ruby base containers">ruby base containers</a>,
			<a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a>,
			<a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>,
			and/or
			<a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>
			(and any intervening <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#white-space title="white space">white space</a>)
			is wrapped in an anonymous <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>.
			For the purpose of this step:
			<ul>
				<li>an improperly-contained <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> is one not parented by a <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> or <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
				<li>an improperly-contained <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> is one not parented by a <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a> or <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
				<li>an improperly-contained <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> or <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>
				    is one not parented by a <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
			</ul>

		<li id=anon-gen-inlinize><a class=self-link href=#anon-gen-inlinize></a><strong>Inlinize block-level boxes:</strong>
			Any in-flow block-level boxes directly contained by a
			<a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>,
			<a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>,
			<a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>,
			<a data-link-type=dfn href=#ruby-base-box title="ruby base box">ruby base box</a>,
			or <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation box">ruby annotation box</a>
			are forced to be inline-level boxes,
			and their <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> value computed accordingly.
			For example,
			the <a class=property data-link-type=propdesc href=#propdef-display title=display>display</a> property of an in-flow element with <a class=css data-link-type=propdesc href=#propdef-display title=display>display: block</a>
			parented by an element with <a class=css data-link-type=propdesc href=#propdef-display title=display>display: ruby-text</a>
			computes to <span class=css>inline-block</span>.
			This computation occurs after any intermediary anonymous-box fixup
			(such as that required by internal table elements).

		<li id=anony-gen-trim-space><a class=self-link href=#anony-gen-trim-space></a><strong>Trim leading/trailing white space:</strong>
			Any white space within a ruby structure is discarded
			at the beginning and end of
			a <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>, <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>, or <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>.

		<li id=anon-gen-bare-inlines><a class=self-link href=#anon-gen-bare-inlines></a><strong>Wrap misparented inline-level content:</strong>
			Any consecutive sequence of text and inline-level boxes
			directly parented by a <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> or <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
			is wrapped in an anonymous <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>.
			Similarly, any consecutive sequence of text and inline-level boxes
			directly parented by a <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>
			is wrapped in an anonymous <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>.

<p>However, if an anonymous box so constructed contains only <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#white-space title="white space">white space</a>,
			it is considered <dfn data-dfn-type=dfn data-noexport="" id=intra-ruby-white-space>intra-ruby white space<a class=self-link href=#intra-ruby-white-space></a></dfn>
			and is either discarded as <a data-link-type=dfn href=#inter-level-white-space title="inter-level white space">inter-level white space</a>
			or preserved as <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a>
			as described below.</p>

		<li id=anon-gen-discard-space><a class=self-link href=#anon-gen-discard-space></a><strong>Remove inter-level white space:</strong>
			Any <a data-link-type=dfn href=#intra-ruby-white-space title="intra-ruby white space">intra-ruby white space</a>
			whose immediately adjacent siblings match one of the patterns below
			is <dfn data-dfn-type=dfn data-noexport="" id=inter-level-white-space>inter-level white space<a class=self-link href=#inter-level-white-space></a></dfn>
			and is removed, as if it had <a class=css data-link-type=propdesc href=#propdef-display title=display>display: none</a>.
			<table class=data>
			<thead>
				<tr><th>Previous box
				    <th>Next box
			<tbody>
				<tr><td><var>any</var>
				    <td><a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>
				<tr><td>not <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>
				    <td><a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>

			</table>

		<li id=anon-gen-interpret-space><a class=self-link href=#anon-gen-interpret-space></a><strong>Interpret intra-level white space:</strong>
			Any <a data-link-type=dfn href=#intra-ruby-white-space title="intra-ruby white space">intra-ruby white space</a> box
			whose immediately adjacent siblings match one of the patterns below
			is assigned the box type and subtype defined in the table below:
			<table class=data>
			<colgroup span=2></colgroup>
			<colgroup span=2></colgroup>
			<thead>
				<tr><th>Previous box
				    <th>Next box
				    <th>Box type
				    <th>Subtype
			<tbody>
				<tr><td><a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
				    <td><a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
				    <td><a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
				    <td><dfn data-dfn-type=dfn data-noexport="" id=inter-base-white-space>inter-base white space<a class=self-link href=#inter-base-white-space></a></dfn>
				<tr><td><a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>
				    <td><a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>
				    <td><a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>
				    <td><dfn data-dfn-type=dfn data-noexport="" id=inter-annotation-white-space>inter-annotation white space<a class=self-link href=#inter-annotation-white-space></a></dfn>
				<tr><td><a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> or <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>
				    <td><a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> or <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
				    <td rowspan=3><a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
				    <td rowspan=3><dfn data-dfn-type=dfn data-noexport="" id=inter-segment-white-space>inter-segment white space<a class=self-link href=#inter-segment-white-space></a></dfn>
				<tr><td><a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> or <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
				    <td><a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
				<tr><td><a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
				    <td><a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
			</table>
			The <dfn data-dfn-type=dfn data-noexport="" id=intra-level-white-space>intra-level white space<a class=self-link href=#intra-level-white-space></a></dfn> boxes defined above are
			treated specially for pairing and layout. See below.

		<li id=anon-gen-unbreak><a class=self-link href=#anon-gen-unbreak></a><strong>Suppress line breaks:</strong>
			Convert all forced line breaks inside <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> (regardless of <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-text-3/#propdef-white-space title=white-space>white-space</a> value)
			as defined for <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#collapsible-white-space title=collapsible>collapsible</a> segment breaks in <a href=http://www.w3.org/TR/css-text-3/#line-break-transform>CSS Text Level 3 § 4.1.2</a>.
			<p class=issue id=issue-8af70305><a class=self-link href=#issue-8af70305></a>The goal of this is to simplify the layout model by suppressing any line breaks within ruby annotations.
			Alternatively we could try to define some kind of acceptable behavior for them.

		<li id=anon-gen-anon-containers><a class=self-link href=#anon-gen-anon-containers></a><strong>Generate anonymous level containers:</strong>
			Any consecutive sequence of <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> and <a data-link-type=dfn href=#inter-base-white-space title="inter-base white space">inter-base white space</a>
			(and not <a data-link-type=dfn href=#inter-segment-white-space title="inter-segment white space">inter-segment white space</a>)
			not parented by a <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
			is wrapped in an anonymous <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>.
			Similarly, any consecutive sequence of <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> and <a data-link-type=dfn href=#inter-annotation-white-space title="inter-annotation white space">inter-annotation white space</a>
			not parented by a <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>
			is wrapped in an anonymous <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>.
	</ol>

	<p class=issue id=issue-778a7acd><a class=self-link href=#issue-778a7acd></a>Make <a href=http://lists.w3.org/Archives/Public/www-archive/2014Jun/att-0027/PastedGraphic-1.png>this diagram</a> into an example.

	<p>Once all ruby layout structures are properly parented,
	the UA can start to associate bases with their annotations.

	<p class=note>
	Note that the UA is not required to create any of these anonymous boxes
	(or the anonymous empty <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a> boxes in the pairing section)
	in its internal structures,
	as long as pairing and layout behaves as if they existed.

<h3 class="heading settled" data-level=2.3 id=ruby-pairing><span class=secno>2.3. </span><span class=content>
Annotation Pairing</span><a class=self-link href=#ruby-pairing></a></h3>

	<p>Annotation <dfn data-dfn-type=dfn data-noexport="" id=pairing>pairing<a class=self-link href=#pairing></a></dfn> is the process of associating
	<a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> with <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.
	Each <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> is associated with one or more <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>,
	and is said to <dfn data-dfn-type=dfn data-noexport="" id=span>span<a class=self-link href=#span></a></dfn> those bases.
	(A <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> that <a data-link-type=dfn href=#span title=spans>spans</a> multiple bases is called
	a <dfn data-dfn-type=dfn data-noexport="" id=spanning-annotation>spanning annotation<a class=self-link href=#spanning-annotation></a></dfn>.)

<p>A <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> is can be associated with
	only one <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> per <a data-link-type=dfn href=#annotation-level title="annotation level">annotation level</a>.
	However, if there are multiple <a data-link-type=dfn href=#annotation-level title="annotation levels">annotation levels</a>,
	it can be associated with multiple <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>.</p>

<p>Once pairing is complete, ruby “column” units are defined,
	each represented by a single <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
	and one <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> (possibly an empty, anonymous one)
	from each <a data-link-type=dfn href=#annotation-level title="annotation level">annotation level</a> in its <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a>.</p>


<h4 class="heading settled" data-level=2.3.1 id=segment-pairing><span class=secno>2.3.1. </span><span class=content>
Segment Pairing and Annotation Levels</span><a class=self-link href=#segment-pairing></a></h4>

	<p>A ruby structure is divided into <dfn data-dfn-type=dfn data-noexport="" id=ruby-segments>ruby segments<a class=self-link href=#ruby-segments></a></dfn>,
	each consisting of a single <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
	followed by one or more <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a>.
	Each <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a> in a <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a>
	represents one <dfn data-dfn-type=dfn data-noexport="" id=annotation-level title="annotation level | level">level<a class=self-link href=#annotation-level></a></dfn> of annotation for the base text:
	the first one represents the first level of annotation,
	the second one represents the second level of annotation,
	and so on.
	The <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> represents the <dfn data-dfn-type=dfn data-noexport="" id=base-level>base level<a class=self-link href=#base-level></a></dfn>.
	The <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> in each segment is thus paired
	with each of the <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a> in that segment.

	<p>In order to handle degenerate cases, some empty anonymous containers are assumed:
	<ul>
		<li>If the first child of a <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> is a <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>,
		an anonymous, empty <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> is assumed to exist before it.
		<li>Similarly, if the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> contains consecutive <a data-link-type=dfn href=#ruby-base-container-box title="ruby base containers">ruby base containers</a>,
		anonymous, empty <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a> are assumed to exist between them.
	</ul>

	<p><a data-link-type=dfn href=#inter-segment-white-space title="Inter-segment white space">Inter-segment white space</a> is effectively a <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a> of its own.

<h4 class="heading settled" data-level=2.3.2 id=base-annotation-pairing><span class=secno>2.3.2. </span><span class=content>
Unit Pairing and Spanning Annotations</span><a class=self-link href=#base-annotation-pairing></a></h4>

	<p>Within a <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a>,
	each <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> in the <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
	is paired with one <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>
	from each <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a> in its <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a>.

	<p>If a <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a> contains only
	a single, anonymous <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>,
	then that <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> is paired with (i.e. <a data-link-type=dfn href=#span title=spans>spans</a> across)
	all of the <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> in its <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a>.

	<p>Otherwise, each <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> is paired,
	in order, with the corresponding <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> in that segment.
	If there are not enough <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> in a <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>,
	the remaining <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> are paired with anonymous empty annotations
	inserted at the end of the <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>.
	If there are not enough <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>,
	any remaining <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> pair with empty, anonymous bases
	inserted at the end of the <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>.

	<p>If an implementation supports ruby markup with explicit spanning
	(e.g. XHTML Complex Ruby Annotations),
	it must adjust the pairing rules to pair <a data-link-type=dfn href=#spanning-annotation title="spanning annotations">spanning annotations</a>
	to their bases appropriately.

	<p><a data-link-type=dfn href=#intra-level-white-space title="Intra-level white space">Intra-level white space</a> does not participate in standard annotation <a data-link-type=dfn href=#pairing title=pairing>pairing</a>.
	However, if the immediately-adjacent <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> or <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>
	are paired
	<ul>
		<li>with two <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> or <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">annotations</a>
		that surround corresponding <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a> in another level,
		then the so-corresponding <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a> boxes are also paired.
		<li>with a single spanning <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>,
		then the <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a> is also paired to that <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a>
		<li>with two <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> or <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">annotations</a>
		with no intervening <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a>,
		then the <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a> box pairs with
		an anonymous empty <a data-link-type=dfn href=#intra-level-white-space title="intra-level white space">intra-level white space</a> box assumed to exist between them.
	</ul>

	<p class=issue id=issue-0230a91a><a class=self-link href=#issue-0230a91a></a>Insert diagram</p>

<h4 class="heading settled" data-level=2.3.3 id=nested-pairing><span class=secno>2.3.3. </span><span class=content>
Complex Spanning with Nested Ruby</span><a class=self-link href=#nested-pairing></a></h4>

	<p><dfn data-dfn-type=dfn data-noexport="" id=nested-ruby title="nested ruby"><a class=self-link href=#nested-ruby></a></dfn>When <a data-link-type=dfn href=#ruby-container title="ruby containers">ruby containers</a> are nested,
	pairing begins with the deepest <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>,
	then expands out.
	From the pairing perspective of the outer <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>,
	each <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> nested within another <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
	counts as representing a single <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>/<a data-link-type=dfn href=#ruby-annotation-box title=annotation>annotation</a> per level.
	The outer <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>’s <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> paired to the <a data-link-type=dfn href=#nested-ruby title="nested ruby">nested ruby</a>
	are therefore paired with (and <a data-link-type=dfn href=#span title=span>span</a>) all of the nested <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>’s <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.
	Each <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a> in the nested <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
	occupies the same <a data-link-type=dfn href=#annotation-level title="annotation level">annotation level</a> in the outer <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
	as it does in the inner one
	and participates in its layout as if it were directly contained in the outer <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>.

	<p>This process is recursive.
	Thus, using nested <a data-link-type=dfn href=#ruby-container title="ruby containers">ruby containers</a> allows the representation
	of complex spanning relationships.

	<p class=issue id=issue-9b177ca3><a class=self-link href=#issue-9b177ca3></a>It’s not clear whether this falls out of layout handling of ruby containers inside ruby bases
	or needs to be handled specially.
	Waiting until layout is better-defined to find out...

<h3 class="heading settled" data-level=2.4 id=autohide><span class=secno>2.4. </span><span class=content>
Autohiding Base-identical Annotations</span><a class=self-link href=#autohide></a></h3>

	<p>If a <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> has the exact same text content as its base,
	it is <dfn data-dfn-type=dfn data-noexport="" id=hidden-ruby-annotation title="hidden ruby annotation | hidden annotation">hidden<a class=self-link href=#hidden-ruby-annotation></a></dfn>.
	Hiding a <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> does not affect annotation pairing
	or the block-axis positioning of boxes in other <a data-link-type=dfn href=#annotation-level title=levels>levels</a>.
	However the <a data-link-type=dfn href=#hidden-ruby-annotation title="hidden annotation">hidden annotation</a> is not visible,
	and it has no impact on layout
	other than to separate adjacent sequences of <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a> within its level,
	as if they belonged to separate segments
	and the <a data-link-type=dfn href=#hidden-ruby-annotation title="hidden annotation">hidden annotation</a>’s base were not a <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> but an intervening inline.

	<div class=example>
		<p>This is to allow correct inlined display of annotations
		for Japanese words that are a mix of kanji and hiragana.
		For example, the word <span lang=ja>振り仮名</span> should be inlined as
		<p class=figure>振り仮名(ふりがな)
		<p>and therefore marked up as
		<pre>&lt;ruby&gt;
  &lt;rb&gt;振&lt;/rb&gt;&lt;rb&gt;り&lt;/rb&gt;&lt;rb&gt;仮&lt;/rb&gt;&lt;rb&gt;名&lt;/rb&gt;
  &lt;rp&gt;(&lt;/rp&gt;&lt;rt&gt;ふ&lt;/rt&gt;&lt;rt&gt;り&lt;/rt&gt;&lt;rt&gt;が&lt;/rt&gt;&lt;rt&gt;な&lt;/rt&gt;&lt;rp&gt;)&lt;/rp&gt;
&lt;ruby&gt;</pre>
		<p>However, when displayed as ruby, the “り” should be hidden
		<div class=figure>
			<p><img alt="Hiragana annotations for 振り仮名 appear, each pronunciation above its kanji base character." src=images/furigana-separate.png>
			<p class=caption>Hiragana ruby for 振り仮名. Notice there is no hiragana annotation above り,  since it is already in hiragana.
		</div>
	</div>

	<p>The content comparison for this auto-hiding behavior
	takes place prior to white space collapsing (<a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-text-3/#propdef-white-space title=white-space>white-space</a>) and text transformation (<a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-text-3/#propdef-text-transform title=text-transform>text-transform</a>)
	and ignores elements (considers only the <code>textContent</code> of the boxes).

	<p class=note>
		Future levels of CSS Ruby may add controls for auto-hiding,
		but in this level it is always forced.

<h3 class="heading settled" data-level=2.5 id=white-space><span class=secno>2.5. </span><span class=content>
White Space Collapsing</span><a class=self-link href=#white-space></a></h3>

	<p>White space within a ruby structure is <a href=#anon-gen-discard-space>discarded</a>
	<ul>
		<li>at the beginning and end of a <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>, <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>, or <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>,
		<li>between a <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> and its following <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>,
		<li>between <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a>.
	</ul>

	<div class=example>
		For example, the following markup will display without any spaces:
		<pre>&lt;ruby&gt;
  &lt;rb&gt;東&lt;/rb&gt;&lt;rb&gt;京&lt;/rb&gt;
  &lt;rt&gt;とう&lt;/rt&gt;&lt;rt&gt;きょう&lt;/rt&gt;
  &lt;rt&gt;Tō&lt;/rt&gt;&lt;rt&gt;kyō&lt;/rt&gt;
&lt;/ruby&gt;</pre>
	</div>

	<p>Between <a data-link-type=dfn href=#ruby-segments title="ruby segments">ruby segments</a>, between <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>, and between <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>, however,
	white space is not discarded,
	and is maintained for rendering
	as <a data-link-type=dfn href=#inter-base-white-space title="inter-base white space">inter-base</a>,
	<a data-link-type=dfn href=#inter-annotation-white-space title="inter-annotation white space">inter-annotation</a>,
	or <a data-link-type=dfn href=#inter-segment-white-space title="inter-segment white space">inter-segment white space</a>.
	(See <a href=#box-fixup>Anonymous Ruby Box Generation</a>, above.)

	<div class=example>
		<p>The rules preserving white space allow ruby to be used with space-separated scripts such as Latin.
		For example,
		<pre>&lt;ruby&gt;
  &lt;rb&gt;W&lt;/rb&gt;&lt;rb&gt;W&lt;/rb&gt;&lt;rb&gt;W&lt;/rb&gt;
  &lt;rt&gt;World&lt;/rt&gt; &lt;rt&gt;Wide&lt;/rt&gt; &lt;rt&gt;Web&lt;/rt&gt;
&lt;/ruby&gt;</pre>
		<p>They also ensure that annotated white space is preserved. For example,
		<pre>&lt;ruby&gt;
  &lt;rb&gt;Aerith&lt;/rb&gt;&lt;rb&gt; &lt;/rb&gt;&lt;rb&gt;Gainsboro&lt;/rb&gt;
  &lt;rt&gt;エアリス&lt;/rt&gt;&lt;rt&gt;・&lt;/rt&gt;&lt;rt&gt;ゲインズブール&lt;/rt&gt;
&lt;/ruby&gt;</pre>
	</div>

	<p>Where undiscarded white space is <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#collapsible-white-space title=collapsible>collapsible</a>, it will collapse
	following the standard <a href=http://www.w3.org/TR/css3-text/#white-space-rules>white space processing rules</a>. <a data-biblio-type=normative data-link-type=biblio href=#biblio-css3text title=CSS3TEXT>[CSS3TEXT]</a>
	For <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#collapsible-white-space title="collapsible white space">collapsible white space</a> between <a data-link-type=dfn href=#ruby-segments title="ruby segments">ruby segments</a> (<a data-link-type=dfn href=#inter-segment-white-space title="inter-segment white space">inter-segment white space</a>), however,
	the contextual text for determining collapsing behavior is given by the <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> on either side,
	not the text on either side of the white space in source document order.

	<div class=note>
		<p>Note that the white space processing rules
		cause a white space sequence containing a <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#segment-break title="segment break">segment break</a> (such as a line feed)
		to <a href=http://www.w3.org/TR/css3-text/#line-break-transform>collapse to nothing</a> between Han and Kana characters.
		This means that Chinese and Japanese ruby can safely use white space for indentation of ruby markup.
		For example, the following markup will display without any spaces:
		<pre>&lt;ruby&gt;
  屋&lt;rt&gt;おく&lt;/rt&gt;内&lt;rt&gt;ない&lt;/rt&gt;
  禁&lt;rt&gt;きん&lt;/rt&gt;煙&lt;rt&gt;えん&lt;/rt&gt;
&lt;/ruby&gt;</pre>
		<p>However, white space that does not contain a <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#segment-break title="segment break">segment break</a> does not collapse completely away,
		so this markup will display with a space between the first and second ruby pairs:
		<pre>&lt;ruby&gt;
  屋&lt;rt&gt;おく&lt;/rt&gt;  内&lt;rt&gt;ない&lt;/rt&gt;
  禁&lt;rt&gt;きん&lt;/rt&gt;  煙&lt;rt&gt;えん&lt;/rt&gt;
&lt;/ruby&gt;</pre>
	</div>

<h2 class="heading settled" data-level=3 id=ruby-layout><span class=secno>3. </span><span class=content>
Ruby Layout</span><a class=self-link href=#ruby-layout></a></h2>

	<p>When a ruby structure is laid out,
	its <a data-link-type=dfn href=#base-level title="base level">base level</a> is laid out on the line,
	aligned according to its <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-vertical-align title=vertical-align>vertical-align</a> property
	exactly as if its <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> were a regular sequence of inline boxes.
	Each <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> is sized and positioned
	to contain exactly the full height of its <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.

	<p><a data-link-type=dfn href=#ruby-annotation-box title="Ruby annotations">Ruby annotations</a> associated with the <a data-link-type=dfn href=#base-level title="base level">base level</a>
	are then positioned with respect to their <a data-link-type=dfn href=#ruby-base-box title="ruby base boxes">ruby base boxes</a>
	according to the applicable <a class=property data-link-type=propdesc href=#propdef-ruby-position title=ruby-position>ruby-position</a> values.
	<a data-link-type=dfn href=#ruby-annotation-box title="Ruby annotations">Ruby annotations</a> within a level (within a single <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>)
	are aligned to each other as if they were inline boxes
	participating in the same inline formatting context.
	Each <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a> is sized and positioned
	to contain exactly the full height of its <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>.

	<p>A ruby container (or fragment thereof)
	measures as wide as the content of its widest level.
	Similarly, <a data-link-type=dfn href=#ruby-base-box title="ruby base boxes">ruby base boxes</a> and <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a>
	within a ruby “column” have the measure of the widest content in that “column”.
	In the case of <a data-link-type=dfn href=#spanning-annotation title="spanning annotations">spanning annotations</a>
	(whether actually spanning or pretending to span per <a class=property data-link-type=propdesc href=#propdef-ruby-merge title=ruby-merge>ruby-merge</a>),
	the measures of the <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation box">ruby annotation box</a> and
	the sum of its associated <a data-link-type=dfn href=#ruby-base-box title="ruby base boxes">ruby base boxes</a> must match.

	<p>How the extra space is distributed
	when ruby content is narrower than the measure of its box
	is specified by the <a class=property data-link-type=propdesc href=#propdef-ruby-align title=ruby-align>ruby-align</a> property.

<h3 class="heading settled" data-level=3.1 id=inter-character-layout><span class=secno>3.1. </span><span class=content>
Inter-character Ruby Layout</span><a class=self-link href=#inter-character-layout></a></h3>

	<p>Inter-character annotations have special layout.
	When <a class=property data-link-type=propdesc href=#propdef-ruby-position title=ruby-position>ruby-position</a> indicates <a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a> annotations,
	the affected <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a>
	are spliced into and measured as part of the layout of the <a data-link-type=dfn href=#base-level title="base level">base level</a>.
	The <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a> must be sized to include both the <a data-link-type=dfn href=#ruby-base-box title="ruby base boxes">ruby base boxes</a>
	as well as the <a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a> <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a>.
	The affected <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a> is similarly sized
	so that its content box coincides with that of the <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>.

	<p>For the purpose of laying out other levels of annotations,
	an <a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a> annotation effectively becomes part of its base.
	<span class=issue id=issue-029133da><a class=self-link href=#issue-029133da></a>Or should it become a quasi-base between two bases?</span>
	A spanning <a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a> annotation is placed after
	all the bases that it spans.

<h3 class="heading settled" data-level=3.2 id=box-style><span class=secno>3.2. </span><span class=content>
Styling Ruby Boxes</span><a class=self-link href=#box-style></a></h3>

	<p>In most respects, ruby boxes can be styled similar to inline boxes.
	However, the UA is not required to support
	any of the box properties (borders, margins, padding),
	any of the background properties or outline properties,
	or any other property that illustrates the bounds of the box
	on <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container boxes">ruby base container boxes</a>, <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container boxes">ruby annotation container boxes</a>,
	or <a href=#nested-pairing>ruby-internal ruby container boxes</a>.
	The UA may implement these boxes simply as abstractions for inheritance
	and control over the layout of their contents.

<h3 class="heading settled" data-level=3.3 id=line-breaks><span class=secno>3.3. </span><span class=content>
Breaking Across Lines</span><a class=self-link href=#line-breaks></a></h3>

	<p>When there is not enough space for an entire <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> to fit on the line,
	the ruby may be broken wherever all levels simultaneously allow a break.
	Ruby most often breaks between base-annotation sets,
	but if the line-breaking rules allow it, can also break within a <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
	(and, in parallel, its associated <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a>).

	<p>Whenever ruby breaks across lines, <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> must stay
	with their respective <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.
	The line <em>must not</em> break between a <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> and its <a data-link-type=dfn href=#ruby-annotation-box title=annotations>annotations</a>,
	even in the case of <a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a> <a data-link-type=dfn href=#ruby-annotation-box title=annotations>annotations</a>.

	<div class=figure>
		<img alt='Diagram showing the line breaking opportunity in a "Bopomofo" ruby' src=images/r-break-b.gif>
		<p class=caption><a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a> ruby line breaking opportunity
	</div>

<h4 class="heading settled" data-level=3.3.1 id=break-between><span class=secno>3.3.1. </span><span class=content>
Breaking Between Bases</span><a class=self-link href=#break-between></a></h4>

	<p>In typical cases, <a data-link-type=dfn href=#ruby-base-box title="ruby base boxes">ruby base boxes</a> and <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a>
	are styled to forbid internal line wrapping and do not contain forced breaks.
	(See <a href=#default-stylesheet>Appendix A</a>.)
	In such cases the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a> can only break between adjacent <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>,
	and only if no <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> span those <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.

	<div class=figure>
		<p><img alt="Diagram showing the line breaking opportunity in a complex ruby" src=images/r-break-a.gif>
		<p class=caption>Ruby line breaking opportunity
	</div>

	<p>Whether ruby can break between two adjacent <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>
	is controlled by normal line-breaking rules for the base text,
	exactly as if the <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> were adjacent inline boxes.
	(The annotations are ignored when determining soft wrap opportunities for the <a data-link-type=dfn href=#base-level title="base level">base level</a>.)

	<div class=example>
		<p>For example, if two adjacent ruby bases are “蝴” and “蝶”,
		the line may break between them,
		because lines are normally allowed to break between two Han characters.
		However, if <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-text-3/#propdef-word-break title=word-break>word-break</a> is <span class=css>keep-all</span>, that line break is forbidden.
<pre>&lt;ruby&gt;蝴&lt;rt&gt;hú&lt;/rt&gt;蝶&lt;rt&gt;dié&lt;/rt&gt;</pre>
	</div>

	<p>Inter-base white space is significant for evaluating line break opportunities between <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.
	As with white space between inlines, it collapses when the line breaks there.
	Similarly, annotation white space is also trimmed at a line break.

	<div class=example>
		<p>For example, given the following markup:
<pre>&lt;ruby&gt;&lt;rb&gt;one&lt;/rb&gt; &lt;rb&gt;two&lt;/rb&gt; &lt;rt&gt;1&lt;/rt&gt; &lt;rt&gt;2&lt;/rt&gt;&lt;/ruby&gt;</pre>
		<p>Due to the space, the line may break between “one” and “two“.
		If the line breaks there, that space—and the space between “1” and “2”—disappears,
		in accordance with standard CSS white space processing rules. <a data-biblio-type=informative data-link-type=biblio href=#biblio-css3text title=CSS3TEXT>[CSS3TEXT]</a>
	</div>

<h4 class="heading settled" data-level=3.3.2 id=break-within><span class=secno>3.3.2. </span><span class=content>
Breaking Within Bases</span><a class=self-link href=#break-within></a></h4>

	<p>For longer base texts, it is sometimes appropriate to allow breaking within a base-annotation pair.
	For example, if an English sentence is annotated with its Japanese translation,
	allowing the text to wrap allows for reasonable line breaking behavior in the paragraph.

	<p class=issue id=issue-14d7c6b1><a class=self-link href=#issue-14d7c6b1></a>
	Insert scanned example so people don’t think this is just the ramblings of an insane spec-writer.

	<p>Line-breaking within a <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> is only allowed if the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-text-3/#propdef-white-space title=white-space>white-space</a> property
	of the <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> and all its parallel <a data-link-type=dfn href=#ruby-annotation-box title=annotations>annotations</a> allow it,
	and there exists a <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#soft-wrap-opportunity title="soft wrap opportunity">soft wrap opportunity</a> <em>within</em> (i.e. not at the start or end)
	the content of each base/annotation box.
	Since there is no structural correspondence between fragments of content
	within <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> and <a data-link-type=dfn href=#ruby-annotation-box title=annotations>annotations</a>,
	the UA may break at any set of opportunities;
	but it is recommended that the UA attempt to proportionally balance
	the amount of content inside each fragment.

	<p>There are no line breaking opportunities within <a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a> <a data-link-type=dfn href=#ruby-annotation-box title=annotations>annotations</a>.

	<p>Ruby alignment takes place within each fragment, after line-breaking.

<h3 class="heading settled" data-level=3.4 id=bidi><span class=secno>3.4. </span><span class=content>
Bidi Reordering</span><a class=self-link href=#bidi></a></h3>

	<p>The Unicode bidirectional algorithm reorders logically-stored text for visual presentation
	when characters from scripts of opposing directionalities are mixed
	within a single paragraph.

	<p>To preserve the correspondance of <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>
	to their respective <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>,
	a few restrictions must be imposed:
	<ul>
		<li>The contents of a <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> or <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> must remain contiguous.
		<li><a data-link-type=dfn href=#ruby-annotation-box title="Ruby annotations">Ruby annotations</a> must be reordered together with their <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a>.
		<li>All <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> spanned by a single <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> must remain contiguous.
	</ul>

	<p>To this end,
	<ul>
		<li>
			Bidi isolation is forced on all <a data-link-type=dfn href=#internal-ruby-boxes title="internal ruby boxes">internal ruby boxes</a> and the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>:
			the <span class=css>normal</span> and <span class=css>embed</span> values of <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-writing-modes-3/#propdef-unicode-bidi title=unicode-bidi>unicode-bidi</a> compute to <span class=css>isolate</span>,
			and <span class=css>bidi-override</span> computes to <span class=css>isolate-override</span>.
			<p class=note>
				Note this means that implicit bidi reordering does not work across ruby bases,
				so authors will need to ensure that the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>’s declared directionality
				does indeed match its contents.
		<li>
			During layout, <a data-link-type=dfn href=#ruby-segments title="ruby segments">ruby segments</a> are ordered within the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
			by the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-writing-modes-3/#propdef-direction title=direction>direction</a> property of their <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>.
		<li>
			Within a segment, <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> and <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>
			are ordered within their respective containers
			by the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-writing-modes-3/#propdef-direction title=direction>direction</a> property of the segment’s <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>.
			<span class=note>
				Note this means the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-writing-modes-3/#propdef-direction title=direction>direction</a> property on <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a>
				is ignored for the purpose of layout.
				However, it can still inherit into the container’s children
				and thereby affect the <a data-link-type=dfn href=http://dev.w3.org/csswg/css-writing-modes-3/#inline-base-direction title="inline base direction">inline base direction</a>
				of any <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> it contains.
			</span>
	</ul>

	<p>As with other inline-level content,
	the bidi reordering of <a data-link-type=dfn href=#internal-ruby-boxes title="internal ruby boxes">internal ruby boxes</a> happens after line-breaking
	so that content is divided across lines according to its logical order.

	<p>See <a data-biblio-type=informative data-link-type=biblio href=#biblio-css3-writing-modes title=CSS3-WRITING-MODES>[CSS3-WRITING-MODES]</a> for a more in-depth discussion of bidirectional text in CSS.

	

<h3 class="heading settled" data-level=3.5 id=line-height><span class=secno>3.5. </span><span class=content>
Line Spacing</span><a class=self-link href=#line-height></a></h3>

	<p>The <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-line-height title=line-height>line-height</a> property controls spacing between lines in CSS.
	When inline content on line is shorter than the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-line-height title=line-height>line-height</a>,
	half-leading is added on either side of the content,
	as specified in <a href=http://www.w3.org/TR/CSS21/visudet.html#line-height>CSS2.1§10.8</a>. <a data-biblio-type=normative data-link-type=biblio href=#biblio-css21 title=CSS21>[CSS21]</a>

	<p>In order to ensure consistent spacing of lines,
	documents with ruby typically ensure that the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-line-height title=line-height>line-height</a> is large enough
	to accommodate ruby between lines of text.
	Therefore, ordinarily, <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a> and <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a>
	do not contribute to the measured height of a line’s inline contents;
	any alignment (see <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-vertical-align title=vertical-align>vertical-align</a>) and line-height calculations
	are performed using only the <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>,
	exactly as if it were a normal inline.

	<p>However, if the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-line-height title=line-height>line-height</a> specified on the <a data-link-type=dfn href=#ruby-container title="ruby container">ruby container</a>
	is less than the distance between
	the top of the top <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>
	and the bottom of the bottom <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation container">ruby annotation container</a>,
	then additional leading is added
	on the appropriate side of the <a data-link-type=dfn href=#ruby-base-container-box title="ruby base container">ruby base container</a>
	such that if a block consisted of three lines
	each containing ruby identical to this,
	none of the <a data-link-type=dfn href=#ruby-container title="ruby containers">ruby containers</a> would overlap.

	<p class=note>Note that this does not ensure that the <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> remain within the line box.
	It merely ensures that <em>if all lines had equal spacing</em>
	and equivalent amounts and positioning of <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a>,
	there would be enough room to avoid overlap.

	<p>Authors should ensure appropriate <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-line-height title=line-height>line-height</a> and <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/box.html#propdef-padding title=padding>padding</a> to accommodate ruby,
	and be particularly careful at the beginning or end of a block
	and when a line contains inline-level content
	(such as images, inline blocks, or elements shifted with <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css2/visudet.html#propdef-vertical-align title=vertical-align>vertical-align</a>)
	taller than the paragraph’s default font size.

	<div class=figure>
		<p><img alt="The content of each line sits in the middle of its line height;
		             the additional space on each side is called half-leading.
		             Ruby fits between lines if it is smaller than twice the half-leading,
		             but this means that it occupies space belonging to the half-leading of the previous line." src=images/rlh-a.gif>
		<p class=caption>Ruby annotations will often overflow the line;
		authors should ensure content over/under a ruby-annotated line
		is adequately spaced to leave room for the ruby.
	</div>

	<p class=note>More control over how ruby affects alignment and line layout
	will be part of the CSS Line Layout Module Level 3.
	Note, it is currently in the process of being rewritten;
	the current drafts should not be relied upon.

<h2 class="heading settled" data-level=4 id=ruby-props><span class=secno>4. </span><span class=content>
Ruby Formatting Properties</span><a class=self-link href=#ruby-props></a></h2>

	<p>The following properties are introduced to control ruby
	<a href=#rubypos>positioning</a>,
	<a href=#collapsed-ruby>text distribution</a>,
	and <a href=#rubyalign>alignment</a>.

<h3 class="heading settled" data-level=4.1 id=rubypos><span class=secno>4.1. </span><span class=content>
Ruby Positioning: the <a class=property data-link-type=propdesc href=#propdef-ruby-position title=ruby-position>ruby-position</a> property</span><a class=self-link href=#rubypos></a></h3>

	<table class=propdef>
		<tr>
			<th>Name:
			<td><dfn class=css data-dfn-type=property data-export="" id=propdef-ruby-position>ruby-position<a class=self-link href=#propdef-ruby-position></a></dfn><tr>
			<th><a href=#values>Value</a>:
			<td>[ over | under | inter-character ] &amp;&amp; [ right | left ]
		<tr>
			<th>Initial:
			<td>over right
		<tr>
			<th>Applies to:
			<td>ruby annotation containers
		<tr>
			<th>Inherited:
			<td>yes
		<tr>
			<th>Percentages:
			<td>N/A
		<tr>
			<th>Media:
			<td>visual
		<tr>
			<th>Computed value:
			<td>specified value
		<tr>
			<th>Animatable:
			<td>no
		<tr>
			<th>Canonical order:
			<td><abbr title="follows order of property value definition">per grammar</abbr>
	</table>

	<p>This property controls position of the ruby text with respect to its base.
	Values have the following meanings:

	<p class=issue id=issue-8b54b949><a class=self-link href=#issue-8b54b949></a><span class=issuehead>Issue-107: </span> Roland Steiner has requested the addition of an auto value as default. See <a href="http://www.w3.org/Search/Mail/Public/advanced_search?keywords=&amp;hdr-1-name=subject&amp;hdr-1-query=ruby-position%3A+undesirable+default+value+%27before%27+for+complex+ruby&amp;hdr-2-name=from&amp;hdr-2-query=&amp;hdr-3-name=message-id&amp;hdr-3-query=&amp;period_month=&amp;period_year=&amp;index-grp=Public__FULL&amp;index-type=t&amp;type-index=www-style&amp;resultsperpage=20&amp;sortby=date">this thread</a> and <a href="http://www.w3.org/Search/Mail/Public/advanced_search?keywords=&amp;hdr-1-name=subject&amp;hdr-1-query=Styling+of+complex+Ruby&amp;hdr-2-name=from&amp;hdr-2-query=&amp;hdr-3-name=message-id&amp;hdr-3-query=&amp;period_month=&amp;period_year=&amp;index-grp=Public__FULL&amp;index-type=t&amp;type-index=public-i18n-core&amp;resultsperpage=20&amp;sortby=date">this one</a>.</p>
	<dl data-dfn-for=ruby-position>
		<dt><dfn class=css data-dfn-for=ruby-position data-dfn-type=value data-export="" id=valdef-ruby-position-over><a class=css data-link-type=maybe href=#valdef-ruby-position-over title=over>over</a><a class=self-link href=#valdef-ruby-position-over></a></dfn>
		<dd>The ruby text appears <a data-link-type=dfn href=http://dev.w3.org/csswg/css-writing-modes-3/#over title=over>over</a> the base in horizontal text.

			<div class=figure>
				<p><img alt="Diagram of ruby glyph layout in horizontal mode with ruby text appearing above the base" src=images/shinkansen-top.gif>
				<p class=caption>Ruby over Japanese base text in horizontal layout
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-position data-dfn-type=value data-export="" id=valdef-ruby-position-right><a class=css data-link-type=maybe href=#valdef-ruby-position-right title=right>right</a><a class=self-link href=#valdef-ruby-position-right></a></dfn>
		<dd>The ruby text appears on the right side of the base in vertical text.
			<div class=figure>
				<p><img alt="Diagram of ruby glyph layout in vertical mode with ruby text appearing vertically on the right of the base" src=images/shinkansen-right.gif width=33>
				<p class=caption>Ruby to the right of Japanese base text in vertical layout
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-position data-dfn-type=value data-export="" id=valdef-ruby-position-under><a class=css data-link-type=maybe href=#valdef-ruby-position-under title=under>under</a><a class=self-link href=#valdef-ruby-position-under></a></dfn>
		<dd>The ruby text appears under the base in horizontal text.
			This is a relatively rare setting used in ideographic East Asian writing systems,
			most easily found in educational text.

			<div class=figure>
				<p><img alt="Diagram of ruby glyph layout in horizontal mode with ruby text appearing below the base" src=images/shinkansen-bottom.gif>
				<p class=caption>Ruby under Japanese base text in horizontal layout
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-position data-dfn-type=value data-export="" id=valdef-ruby-position-left><a class=css data-link-type=maybe href=#valdef-ruby-position-left title=left>left</a><a class=self-link href=#valdef-ruby-position-left></a></dfn>
		<dd>The ruby text appears on the left side of the base in vertical text.

			<div class=figure>
				<p><img alt="Diagram of ruby glyph layout in vertical mode with ruby text appearing vertically on the left of the base" src=images/shinkansen-left.gif>
				<p class=caption>Ruby to the left of Japanese base text in vertical layout
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-position data-dfn-type=value data-export="" id=valdef-ruby-position-inter-character><a class=css data-link-type=maybe href=#valdef-ruby-position-inter-character title=inter-character>inter-character</a><a class=self-link href=#valdef-ruby-position-inter-character></a></dfn></dt>
		<dd>
			<p>The ruby text appears on the right of the base in horizontal text.
			This value forces the <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-writing-modes-3/#propdef-writing-mode title=writing-mode>writing-mode</a> of the <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> to be vertical.

			<p>This value is provided for the special case of traditional Chinese
			as used especially in Taiwan:
			ruby (made of <a href=#g-bopomofo>bopomofo</a> glyphs) in that context
			appears vertically along the right side of the base glyph,
			even when the layout of the base characters is horizontal:

				<div class=figure>
					<p><img alt="Example of Taiwanese-style ruby" src=images/bopomofo.gif>
					<p class=caption>“Bopomofo” ruby in traditional Chinese
					(ruby text shown in blue for clarity) in horizontal layout
				</div>
			<p class=note>
				Note that the user agent is responsible for ensuring the correct relative alignment and positioning of the glyphs,
				including those corresponding to the tone marks, when displaying.
				Tone marks are spacing characters that occur (in memory) at the end of the ruby text for each base character.
				They are usually displayed in a separate column to the right of the bopomofo characters,
				and the height of the tone mark depends on the number of characters in the syllable.
				One tone mark, however, is placed above the bopomofo, not to the right of it.
			
		</dd>
	</dl>

	<p>If multiple <a data-link-type=dfn href=#ruby-annotation-container-box title="ruby annotation containers">ruby annotation containers</a> have the same <a class=property data-link-type=propdesc href=#propdef-ruby-position title=ruby-position>ruby-position</a>,
	they stack along the block axis,
	with lower levels of annotation closer to the base text.

<h3 class="heading settled" data-level=4.2 id=collapsed-ruby><span class=secno>4.2. </span><span class=content>
Sharing Annotation Space: the <a class=property data-link-type=propdesc href=#propdef-ruby-merge title=ruby-merge>ruby-merge</a> property</span><a class=self-link href=#collapsed-ruby></a></h3>

	<table class=propdef>
		<tr>
			<th>Name:
			<td><dfn class=css data-dfn-type=property data-export="" id=propdef-ruby-merge>ruby-merge<a class=self-link href=#propdef-ruby-merge></a></dfn><tr>
			<th><a href=#values>Value</a>:
			<td>separate | collapse | auto
		<tr>
			<th>Initial:
			<td>separate
		<tr>
			<th>Applies to:
			<td>ruby annotation containers
		<tr>
			<th>Inherited:
			<td>yes
		<tr>
			<th>Percentages:
			<td>N/A
		<tr>
			<th>Media:
			<td>visual
		<tr>
			<th>Computed value:
			<td>specified value
		<tr>
			<th>Animatable:
			<td>no
		<tr>
			<th>Canonical order:
			<td><abbr title="follows order of property value definition">per grammar</abbr>
	</table>

	<p>
		This property controls how ruby annotation boxes should be rendered
		when there are more than one in a ruby container box:
		whether each pair should be kept separate,
		the annotations should be <dfn data-dfn-type=dfn data-noexport="" id=collapsed-annotation title="collapsed annotation">collapsed<a class=self-link href=#collapsed-annotation></a></dfn> and rendered as a group,
		or the separation should be determined based on the space available.

	<p>Possible values:</p>
	<dl data-dfn-for=ruby-merge>
		<dt><dfn class=css data-dfn-for=ruby-merge data-dfn-type=value data-export="" id=valdef-ruby-merge-ruby-mergeseparate title=ruby-merge:separate><span class=css>separate</span><a class=self-link href=#valdef-ruby-merge-ruby-mergeseparate></a></dfn>
		<dd>
			<p>
				Each ruby annotation box is rendered in the same column(s) as its corresponding base box(es).
				This style is called “mono ruby” in <a data-biblio-type=informative data-link-type=biblio href=#biblio-jlreq title=JLREQ>[JLREQ]</a>.

			<div class=example>
				<p>For example, the following two markups render the same:
<pre>&lt;ruby&gt;無&lt;rt&gt;む&lt;/ruby&gt;&lt;ruby&gt;常&lt;rt&gt;じょう&lt;/ruby&gt;</pre>
				<p>and:
<pre>&lt;ruby style="ruby-merge:separate"&gt;&lt;rb&gt;無&lt;rb&gt;常&lt;rt&gt;む&lt;rt&gt;じょう&lt;/ruby&gt;</pre>
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-merge data-dfn-type=value data-export="" id=valdef-ruby-merge-ruby-mergecollapse title=ruby-merge:collapse><span class=css>collapse</span><a class=self-link href=#valdef-ruby-merge-ruby-mergecollapse></a></dfn>
		<dd>
			<p>
				All <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation boxes">ruby annotation boxes</a> within the same <a data-link-type=dfn href=#ruby-segments title="ruby segment">ruby segment</a> on the same line are concatenated,
				and laid out as if their contents belonged to a single <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation box">ruby annotation box</a>
				spanning all their associated <a data-link-type=dfn href=#ruby-base-box title="ruby base boxes">ruby base boxes</a>.
				This style renders similar to “group ruby” in <a data-biblio-type=informative data-link-type=biblio href=#biblio-jlreq title=JLREQ>[JLREQ]</a>,
				except that <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> are kept together with their respective <a data-link-type=dfn href=#ruby-base-box title="ruby bases">ruby bases</a> when breaking lines.
			</p>

			<div class=example>
				<p>The following two markups render the same both characters fit on one line:
<pre>&lt;ruby&gt;無常&lt;rt&gt;むじょう&lt;/ruby&gt;</pre>
				<p>and:
<pre>&lt;ruby style="ruby-merge:collapse"&gt;&lt;rb&gt;無&lt;rb&gt;常&lt;rt&gt;む&lt;rt&gt;じょう&lt;/ruby&gt;</pre>
				<p>However, the second one renders the same as <a class=css data-link-type=propdesc href=#propdef-ruby-position title=ruby-position>ruby-position: separate</a>
				when the two bases are split across lines.
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-merge data-dfn-type=value data-export="" id=valdef-ruby-merge-ruby-mergeauto title=ruby-merge:auto><span class=css>auto</span><a class=self-link href=#valdef-ruby-merge-ruby-mergeauto></a></dfn></dt>
		<dd>
			<p>
				The user agent may use any algorithm to determine how each ruby annotation box
				is rendered to its corresponding base box,
				with the intention that if all annotations fit over their respective bases,
				the result is identical to “mono ruby”,
				but if some annotations are wider than their bases
				the space is shared in some way
				to avoid imposing space between bases.
			<div class=example>
			<p>
				One possible algorithm is described as “jukugo ruby” in <a data-biblio-type=informative data-link-type=biblio href=#biblio-jlreq title=JLREQ>[JLREQ]</a>.
			<p>
				Another, more simplified algorithm of “jukugo ruby” is
				to render as <span class=css>separate</span> if all ruby annotation boxes fit
				within the advances of their corresponding base boxes,
				and render as <span class=css>collapse</span> otherwise.
			</p>
			</div>
		</dd>
	</dl>

<h3 class="heading settled" data-level=4.3 id=ruby-align-property><span class=secno>4.3. </span><span class=content><span id=rubyalign></span>
Ruby Text Distribution: the <a class=property data-link-type=propdesc href=#propdef-ruby-align title=ruby-align>ruby-align</a> property</span><a class=self-link href=#ruby-align-property></a></h3>

	<table class=propdef>
		<tr>
			<th>Name:
			<td><dfn class=css data-dfn-type=property data-export="" id=propdef-ruby-align>ruby-align<a class=self-link href=#propdef-ruby-align></a></dfn><tr>
			<th><a href=#values>Value</a>:
			<td>start | center | space-between | space-around
		<tr>
			<th>Initial:
			<td>space-around
		<tr>
			<th>Applies to:
			<td>ruby bases, ruby annotations, ruby base containers, ruby annotation containers
		<tr>
			<th>Inherited:
			<td>yes
		<tr>
			<th>Percentages:
			<td>N/A
		<tr>
			<th>Media:
			<td>visual
		<tr>
			<th>Computed value:
			<td>specified value (except for initial and inherit)
	</table>

	<p>This property specifies how text is distributed within the various ruby boxes
	when their contents do not exactly fill their respective boxes.
	Note that space distributed by <a class=property data-link-type=propdesc href=#propdef-ruby-align title=ruby-align>ruby-align</a> is unrelated to, and independent of,
	any space distributed due to justification.

	<p>Values have the following meanings:
	<dl data-dfn-for=ruby-align>
		<dt><dfn class=css data-dfn-for=ruby-align data-dfn-type=value data-export="" id=valdef-ruby-align-ruby-alignstart title=ruby-align:start><span class=css>start</span><a class=self-link href=#valdef-ruby-align-ruby-alignstart></a></dfn></dt>
		<dd>The ruby content is aligned with the start edge of its box.
			<div class=figure>
				<p><img alt="Diagram of glyph layout in left aligned ruby when ruby text is shorter than base" height=91 src=images/ra-l.gif width=145><img alt="Diagram of glyph layout in left aligned ruby when ruby text is longer than base" height=91 src=images/ra-l-rb.gif width=145>
				<p class=caption><span class=css>start</span> ruby distribution
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-align data-dfn-type=value data-export="" id=valdef-ruby-align-ruby-aligncenter title=ruby-align:center><span class=css>center</span><a class=self-link href=#valdef-ruby-align-ruby-aligncenter></a></dfn></dt>
		<dd>The ruby content is centered within its box.
			<div class=figure>
				<p><img alt="Diagram of glyph layout in center aligned ruby when ruby text is shorter than base" height=91 src=images/ra-c.gif width=145><img alt="Diagram of glyph layout in center aligned ruby when ruby text is longer than base" height=91 src=images/ra-c-rb.gif width=145>
				<p class=caption><span class=css>center</span> ruby distribution
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-align data-dfn-type=value data-export="" id=valdef-ruby-align-ruby-alignspace-between title=ruby-align:space-between><span class=css>space-between</span><a class=self-link href=#valdef-ruby-align-ruby-alignspace-between></a></dfn></dt>
		<dd>
			<p>The ruby content expands as defined for normal text justification
				(as defined by <a class=property data-link-type=propdesc href=http://dev.w3.org/csswg/css-text-3/#propdef-text-justify title=text-justify>text-justify</a>),
				except that if there are no <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#justification-opportunity title="justification opportunities">justification opportunities</a>
				the content is centered.
			<div class=figure>
				<p><img alt="Diagram of glyph layout in distribute-letter aligned ruby when ruby text is shorter than base" height=91 src=images/ra-dl.gif width=145><img alt="Diagram of glyph layout in distribute-letter aligned ruby when ruby text is longer than base" height=91 src=images/ra-dl-rb.gif width=145>
				<p class=caption><span class=css>space-between</span> ruby distribution
			</div>
		</dd>

		<dt><dfn class=css data-dfn-for=ruby-align data-dfn-type=value data-export="" id=valdef-ruby-align-ruby-alignspace-around title=ruby-align:space-around><span class=css>space-around</span><a class=self-link href=#valdef-ruby-align-ruby-alignspace-around></a></dfn></dt>
		<dd>
			<p>As for <span class=css>space-between</span>
			except that there exists an extra <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#justification-opportunity title="justification opportunities">justification opportunities</a>
			whose space is distributed half before and half after the ruby content.
			<div class=example>
				<p>Since a typical implementation will by default define <a data-link-type=dfn href=http://dev.w3.org/csswg/css-text-3/#justification-opportunity title="justification opportunities">justification opportunities</a>
					between every adjacent pair of CJK <i data-link-type=dfn title=characters>characters</i>
					and not between adjacent pairs of Latin <i data-link-type=dfn title=characters>characters</i>,
					this should result in the behavior recommended by <a data-biblio-type=informative data-link-type=biblio href=#biblio-jlreq title=JLREQ>[JLREQ]</a>:
					for wide-cell ruby content to be distributed...
				<div class=figure>
					<p><img alt="Diagram of glyph layout in auto aligned ruby when ruby text is shorter than base" height=91 src=images/ra-ds.gif width=145><img alt="Diagram of glyph layout in auto aligned ruby when ruby text is longer than base" height=91 src=images/ra-ds-rb.gif width=145>
					<p class=caption>Wide-cell text in <span class=css>space-around</span> ruby distribution is spaced apart
				</div>
				<p>... and narrow-cell glyph ruby to be centered.
				<div class=figure>
					<p><img alt="Diagram of glyph layout in auto aligned ruby when halfwidth ruby text is shorter than base" height=91 src=images/ra-c-h.gif width=145><img alt="Diagram of character layout in auto aligned ruby when ruby text is longer than narrow-width base" height=91 src=images/ra-c-rb-h.gif width=145>
					<p class=caption>Narrow-width ruby text in <span class=css>space-around</span> ruby distribution is centered
				</div>
			</div>
		</dd>
	</dl>

	<p class=issue id=issue-c66abaa7><a class=self-link href=#issue-c66abaa7></a>Add a paragraph explaining how to distribute space in situations with spanning annotations.

<h2 class="heading settled" data-level=5 id=edge-effects><span class=secno>5. </span><span class=content>
Edge Effects</span><a class=self-link href=#edge-effects></a></h2>

<h3 class="heading settled" data-level=5.1 id=ruby-overhang><span class=secno>5.1. </span><span class=content>
Overhanging Ruby</span><a class=self-link href=#ruby-overhang></a></h3>

	<p>
		When <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation box">ruby annotation box</a> is longer than its corresponding <a data-link-type=dfn href=#ruby-base-box title="ruby base box">ruby base box</a>,
		the <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation box">ruby annotation box</a> may partially overhang adjacent boxes.
	</p>
	<p>
		This level of the specification does not define
		how much the overhang may be allowed, and under what conditions.
	</p>

	<p>If the ruby text is not allowed to overhang,
	then the ruby behaves like a traditional inline box,
	i.e. only its own contents are rendered within its boundaries
	and adjacent elements do not cross the box boundary:

	<div class=figure>
		<p><img alt="Diagram showing the ruby boxes interacting with adjacent text" src=images/ro-n.gif>
		<p class=caption>Simple ruby whose text is not allowed to overhang adjacent text
	</div>

	<p>However, if <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> content is allowed to overhang adjacent elements
	and it happens to be wider than its base,
	then the adjacent content is partially rendered within the area of the <a data-link-type=dfn href=#ruby-container title="ruby container box">ruby container box</a>,
	while the <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> may partially overlap the upper blank parts of the adjacent content:

	<div class=figure>
	<p><img alt="Diagram showing the ruby boxes interacting with adjacent text" src=images/ro-a.gif>
	<p class=caption>Simple ruby whose text is allowed to overhang adjacent text
	</div>

	<p>The <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotations">ruby annotations</a> related to a <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
	must never overhang another <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>.

	<p>The alignment of the contents of the base or the ruby text
	is not affected by overhanging behavior.
	The alignment is achieved the same way regardless of the overhang behavior setting
	and it is computed before the space available for overlap is determined.
	It is controlled by the <a class=property data-link-type=propdesc href=#propdef-ruby-align title=ruby-align>ruby-align</a> property.

	<p class=issue id=issue-9258d5ed><a class=self-link href=#issue-9258d5ed></a>
		I suspect overhanging interacts with alignment in some cases;
		might need to look into this later.

	<p>This entire logic applies the same way in vertical ideographic layout,
	only the dimension in which it works in such a layout is vertical,
	instead of horizontal.

	<div class=example>
	<p>
		The user agent may use <a data-biblio-type=informative data-link-type=biblio href=#biblio-jis4051 title=JIS4051>[JIS4051]</a> recommendation of
		using one ruby text character length as the maximum overhang length.
		Detailed rules for how ruby text can overhang adjacent characters for Japanese are described by <a data-biblio-type=informative data-link-type=biblio href=#biblio-jlreq title=JLREQ>[JLREQ]</a>.
	</p>
	</div>

<h3 class="heading settled" data-level=5.2 id=line-edge><span class=secno>5.2. </span><span class=content>
Line-edge Alignment</span><a class=self-link href=#line-edge></a></h3>

	<p>
		When a <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation box">ruby annotation box</a> that is longer than its <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a>
		is at the start or end edge of a line,
		the user agent <em>may</em> force the side of the <a data-link-type=dfn href=#ruby-annotation-box title="ruby annotation">ruby annotation</a> that touches the edge of the line
		to align to the corresponding edge of the base.
		This type of alignment is described by <a data-biblio-type=informative data-link-type=biblio href=#biblio-jlreq title=JLREQ>[JLREQ]</a>.
	</p>
	<p>
		This level of the specification does not provide a mechanism to control this behavior.
	</p>
	<div class=figure>
		<p><img alt="Diagram of glyph layout in line-edge aligned ruby when ruby text is shorter than base" src=images/ra-le-l.gif>
			<img alt="Diagram of glyph layout in line-edge aligned ruby when ruby text is longer than base" src=images/ra-le-r.gif>
		<p class=caption>Line-edge alignment
	</div>

	<p></p>

<h2 class="no-num heading settled" id=default-stylesheet><span class=content>
Appendix A: Default Style Sheet</span><a class=self-link href=#default-stylesheet></a></h2>

	<p><em>This section is informative.</em>

<h3 class="no-num heading settled" id=default-ua-ruby><span class=content>
<span class=secno>A.1</span> Supporting Ruby Layout</span><a class=self-link href=#default-ua-ruby></a></h3>

	<p>The following represents a default UA style sheet
	for rendering HTML and XHTML ruby markup as ruby layout:

	<pre>ruby { display: ruby; }
rb   { display: ruby-base; white-space: nowrap; }
rp   { display: none; }
rt   { display: ruby-text; white-space: nowrap; font-size: 50%; }
rbc  { display: ruby-base-container; }
rtc  { display: ruby-text-container; }
ruby, rb, rt, rbc, rtc { unicode-bidi: isolate; }</pre>

	<p>Additional rules for UAs supporting the relevant features of <a data-biblio-type=informative data-link-type=biblio href=#biblio-css3-text-decor title=CSS3-TEXT-DECOR>[CSS3-TEXT-DECOR]</a> and <a data-biblio-type=informative data-link-type=biblio href=#biblio-css3-fonts title=CSS3-FONTS>[CSS3-FONTS]</a>:
<pre>rt { font-variant-east-asian: ruby; text-emphasis: none; }</pre>

	<p class=note>Authors should not use the above rules;
	a UA that supports ruby layout should provide these by default.

<h3 class="no-num heading settled" id=default-inline><span class=content>
<span class=secno>A.2</span> Inlining Ruby Annotations</span><a class=self-link href=#default-inline></a></h3>

	<p>The following represents a sample style sheet
	for rendering HTML and XHTML ruby markup as inline annotations:

	<pre>ruby, rb, rt, rbc, rtc, rp {
  display: inline; white-space: inherit;
  font-variant-east-asian: inherit; text-emphasis: inherit; }</pre>

<h3 class="no-num heading settled" id=default-parens><span class=content>
<span class=secno>A.3</span> Generating Parentheses</span><a class=self-link href=#default-parens></a></h3>

	<p>Unfortunately, because Selectors cannot match against text nodes,
	it’s not possible with CSS to express rules that will automatically and correctly
	add parentheses to unparenthesized ruby annotations in HTML.
	(This is because HTML ruby allows implying the <a data-link-type=dfn href=#ruby-base-box title="ruby base">ruby base</a> from raw text, without a corresponding element.)
	However, these rules will handle cases where either <code>&lt;rb&gt;</code>
	or <code>&lt;rtc&gt;</code> is used rigorously.

	<pre>/* Parens around &lt;rtc&gt; */
rtc::before { content: "("; }
rtc::after  { content: ")"; }

/* Parens before first &lt;rt&gt; not inside &lt;rtc&gt; */
rb  + rt::before,
rtc + rt::before { content: "("; }

/* Parens after &lt;rt&gt; not inside &lt;rtc&gt; */
rb ~ rt:last-child::after,
rt + rb::before  { content: ")"; }
rt + rtc::before { content: ")("; }</pre>

<h2 class="heading settled" data-level=6 id=glossary><span class=secno>6. </span><span class=content>
Glossary</span><a class=self-link href=#glossary></a></h2>
<dl>
  <dt id=g-bopomofo lang=zh><a class=self-link href=#g-bopomofo></a>Bopomofo
    <dd>37 characters and 4 tone markings used as phonetics in Chinese,
      especially standard Mandarin.</dd>
  <dt id=g-hanja lang=ko><a class=self-link href=#g-hanja></a>Hanja
    <dd>Subset of the Korean writing system that utilizes ideographic
      characters borrowed or adapted from the Chinese writing system. Also see
      <a href=#g-kanji><span lang=ja>Kanji</span></a>.</dd>
  <dt id=g-hiragana lang=ja><a class=self-link href=#g-hiragana></a>Hiragana
    <dd>Japanese syllabic script, or character of that script. Rounded and 
    cursive in appearance. Subset of the Japanese writing system, used together 
    with kanji and katakana. In recent times, mostly used to write Japanese 
    words when kanji are not available or appropriate, and word endings and 
    particles. Also see <a href=#g-katakana><span lang=ja>Katakana</span></a>.</dd>
  <dt id=g-ideogram><a class=self-link href=#g-ideogram></a>Ideograph
    <dd>A character that is used to represent an idea, word, or word component, 
    in contrast to a character from an alphabetic or syllabic script. The most 
    well-known ideographic script is used (with some variation) in East Asia 
    (China, Japan, Korea,...).</dd>
  <dt id=g-kana lang=ja><a class=self-link href=#g-kana></a>Kana
    <dd>Collective term for hiragana and katakana.</dd>
  <dt id=g-kanji><a class=self-link href=#g-kanji></a>Kanji
    <dd>Japanese term for ideographs; ideographs used in Japanese. Subset of the 
    Japanese writing system, used together with hiragana and katakana. Also see <a href=#g-hanja><span lang=ko>Hanja</span></a>.</dd>
  <dt id=g-katakana lang=ja><a class=self-link href=#g-katakana></a>Katakana
    <dd>Japanese syllabic script, or character of that script. Angular in 
    appearance. Subset of the Japanese writing system,  used together with 
    kanji and hiragana. In recent times, mainly used to write foreign words. Also see <a href=#g-hiragana><span lang=ja>Hiragana</span></a>.</dd>
</dl>

<h2 class="no-num heading settled" id=acknowledgments><span class=content>
Acknowledgments</span><a class=self-link href=#acknowledgments></a></h2>

	<p>This specification would not have been possible without the help from:</p>

	<p>
	David Baron,
	Robin Berjon,
	Stephen Deach,
	Martin Dürst,
	Hideki Hiura (<span lang=ja>樋浦 秀樹</span>),
	Masayasu Ishikawa (<span lang=ja>石川雅康</span>),
	Taichi Kawabata,
	Chris Pratley,
	Takao Suzuki (<span lang=ja>鈴木 孝雄</span>),
	Frank Yung-Fong Tang,
	Chris Thrasher,
	Masafumi Yabe (<span lang=ja>家辺勝文</span>),
	Boris Zbarsky,
	Steve Zilles.

	<p>Special thanks goes to the previous editors:
	Michel Suignard and Marcin Sawicki of Microsoft,
	and Richard Ishida of W3C.

<h2 class="no-num heading settled" id=changes><span class=content>
Changes</span><a class=self-link href=#changes></a></h2>

	<p>The following major changes have been made since the previous Working Draft:
	<ul>
		<li>Rewrote anonymous box generation rules and white space handling rules,
		defined specialized pairing of anonymous white space boxes.
		<li>Took nested ruby handling out of pairing.
		(Will be handling it via sizing/layout.)
		<li>Defined bidi layout of ruby structures.
	</ul>

<h2 class="no-ref no-num heading settled" id=conformance><span class=content>
Conformance</span><a class=self-link href=#conformance></a></h2>

<h3 class="no-ref heading settled" id=conventions><span class=content>
Document conventions</span><a class=self-link href=#conventions></a></h3>

    <p>Conformance requirements are expressed with a combination of
    descriptive assertions and RFC 2119 terminology. The key words "MUST",
    "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
    "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this
    document are to be interpreted as described in RFC 2119.
    However, for readability, these words do not appear in all uppercase
    letters in this specification.

    <p>All of the text of this specification is normative except sections
    explicitly marked as non-normative, examples, and notes. <a data-biblio-type=normative data-link-type=biblio href=#biblio-rfc2119 title=RFC2119>[RFC2119]</a></p>

    <p>Examples in this specification are introduced with the words "for example"
    or are set apart from the normative text with <code>class="example"</code>,
    like this:

    <div class=example>
        <p>This is an example of an informative example.</p>
    </div>

    <p>Informative notes begin with the word "Note" and are set apart from the
    normative text with <code>class="note"</code>, like this:

    <p class=note>Note, this is an informative note.</p>

    <p>Advisements are normative sections styled to evoke special attention and are
    set apart from other normative text with <code>&lt;strong class="advisement"&gt;</code>, like
    this:

    <strong class=advisement>
        UAs MUST provide an accessible alternative.
    </strong>

<h3 class="no-ref heading settled" id=conformance-classes><span class=content>
Conformance classes</span><a class=self-link href=#conformance-classes></a></h3>

    <p>Conformance to this specification
    is defined for three conformance classes:
    <dl>
        <dt>style sheet
            <dd>A <a href=http://www.w3.org/TR/CSS21/conform.html#style-sheet>CSS
            style sheet</a>.
        <dt>renderer
            <dd>A <a href=http://www.w3.org/TR/CSS21/conform.html#user-agent>UA</a>
            that interprets the semantics of a style sheet and renders
            documents that use them.
        <dt>authoring tool
            <dd>A <a href=http://www.w3.org/TR/CSS21/conform.html#user-agent>UA</a>
            that writes a style sheet.
    </dl>

    <p>A style sheet is conformant to this specification
    if all of its statements that use syntax defined in this module are valid
    according to the generic CSS grammar and the individual grammars of each
    feature defined in this module.

    <p>A renderer is conformant to this specification
    if, in addition to interpreting the style sheet as defined by the
    appropriate specifications, it supports all the features defined
    by this specification by parsing them correctly
    and rendering the document accordingly. However, the inability of a
    UA to correctly render a document due to limitations of the device
    does not make the UA non-conformant. (For example, a UA is not
    required to render color on a monochrome monitor.)

    <p>An authoring tool is conformant to this specification
    if it writes style sheets that are syntactically correct according to the
    generic CSS grammar and the individual grammars of each feature in
    this module, and meet all other conformance requirements of style sheets
    as described in this module.

<h3 class="no-ref heading settled" id=partial><span class=content>
Partial implementations</span><a class=self-link href=#partial></a></h3>

    <p>So that authors can exploit the forward-compatible parsing rules to
    assign fallback values, CSS renderers <strong>must</strong>
    treat as invalid (and <a href=http://www.w3.org/TR/CSS21/conform.html#ignore>ignore
    as appropriate</a>) any at-rules, properties, property values, keywords,
    and other syntactic constructs for which they have no usable level of
    support. In particular, user agents <strong>must not</strong> selectively
    ignore unsupported component values and honor supported values in a single
    multi-value property declaration: if any value is considered invalid
    (as unsupported values must be), CSS requires that the entire declaration
    be ignored.</p>

<h3 class="no-ref heading settled" id=experimental><span class=content>
Experimental implementations</span><a class=self-link href=#experimental></a></h3>

    <p>To avoid clashes with future CSS features, the CSS2.1 specification
    reserves a <a href=http://www.w3.org/TR/CSS21/syndata.html#vendor-keywords>prefixed
    syntax</a> for proprietary and experimental extensions to CSS.

    <p>Prior to a specification reaching the Candidate Recommendation stage
    in the W3C process, all implementations of a CSS feature are considered
    experimental. The CSS Working Group recommends that implementations
    use a vendor-prefixed syntax for such features, including those in
    W3C Working Drafts. This avoids incompatibilities with future changes
    in the draft.
    </p>

<h3 class="no-ref heading settled" id=testing><span class=content>
Non-experimental implementations</span><a class=self-link href=#testing></a></h3>

    <p>Once a specification reaches the Candidate Recommendation stage,
    non-experimental implementations are possible, and implementors should
    release an unprefixed implementation of any CR-level feature they
    can demonstrate to be correctly implemented according to spec.

    <p>To establish and maintain the interoperability of CSS across
    implementations, the CSS Working Group requests that non-experimental
    CSS renderers submit an implementation report (and, if necessary, the
    testcases used for that implementation report) to the W3C before
    releasing an unprefixed implementation of any CSS features. Testcases
    submitted to W3C are subject to review and correction by the CSS
    Working Group.

    <p>Further information on submitting testcases and implementation reports
    can be found from on the CSS Working Group’s website at
    <a href=http://www.w3.org/Style/CSS/Test/>http://www.w3.org/Style/CSS/Test/</a>.
    Questions should be directed to the
    <a href=http://lists.w3.org/Archives/Public/public-css-testsuite>public-css-testsuite@w3.org</a>
    mailing list.



<h2 class="no-num heading settled" id=references><span class=content>References</span><a class=self-link href=#references></a></h2><h3 class="no-num heading settled" id=normative><span class=content>Normative References</span><a class=self-link href=#normative></a></h3><dl><dt id=biblio-css21 title=CSS21><a class=self-link href=#biblio-css21></a>[CSS21]<dd>Bert Bos; et al. <a href=http://www.w3.org/TR/2011/REC-CSS2-20110607>Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification</a>. 7 June 2011. W3C Recommendation. URL: <a href=http://www.w3.org/TR/2011/REC-CSS2-20110607>http://www.w3.org/TR/2011/REC-CSS2-20110607</a><dt id=biblio-css3-display title=CSS3-DISPLAY><a class=self-link href=#biblio-css3-display></a>[CSS3-DISPLAY]<dd>Tab Atkins. <a href=http://www.w3.org/TR/2014/WD-css-display-3-20140220/>CSS Display Module Level 3</a>. 20 February 2014. W3C Working Draft. (Work in progress.) URL: <a href=http://www.w3.org/TR/2014/WD-css-display-3-20140220/>http://www.w3.org/TR/2014/WD-css-display-3-20140220/</a><dt id=biblio-css3text title=CSS3TEXT><a class=self-link href=#biblio-css3text></a>[CSS3TEXT]<dd>Elika J. Etemad; Koji Ishii. <a href=http://www.w3.org/TR/2012/WD-css3-text-20121113/>CSS Text Module Level 3</a>. 13 November 2012. W3C Working Draft. (Work in progress.) URL: <a href=http://www.w3.org/TR/2012/WD-css3-text-20121113/>http://www.w3.org/TR/2012/WD-css3-text-20121113/</a><dt id=biblio-rfc2119 title=rfc2119><a class=self-link href=#biblio-rfc2119></a>[rfc2119]<dd>S. Bradner. <a href=http://www.ietf.org/rfc/rfc2119.txt>Key words for use in RFCs to Indicate Requirement Levels</a>. March 1997. Best Current Practice. URL: <a href=http://www.ietf.org/rfc/rfc2119.txt>http://www.ietf.org/rfc/rfc2119.txt</a></dl><h3 class="no-num heading settled" id=informative><span class=content>Informative References</span><a class=self-link href=#informative></a></h3><dl><dt id=biblio-css3-text-decor title=CSS3-TEXT-DECOR><a class=self-link href=#biblio-css3-text-decor></a>[CSS3-TEXT-DECOR]<dd>Elika J. Etemad; Koji Ishii. <a href=http://www.w3.org/TR/2013/CR-css-text-decor-3-20130801/>CSS Text Decoration Module Level 3</a>. 1 August 2013. W3C Candidate Recommendation. (Work in progress.) URL: <a href=http://www.w3.org/TR/2013/CR-css-text-decor-3-20130801/>http://www.w3.org/TR/2013/CR-css-text-decor-3-20130801/</a><dt id=biblio-css3-writing-modes title=CSS3-WRITING-MODES><a class=self-link href=#biblio-css3-writing-modes></a>[CSS3-WRITING-MODES]<dd>Elika J. Etemad; Koji Ishii. <a href=http://www.w3.org/TR/2012/WD-css3-writing-modes-20121115/>CSS Writing Modes Module Level 3</a>. 15 November 2012. W3C Working Draft. (Work in progress.) URL: <a href=http://www.w3.org/TR/2012/WD-css3-writing-modes-20121115/>http://www.w3.org/TR/2012/WD-css3-writing-modes-20121115/</a><dt id=biblio-css3val title=CSS3VAL><a class=self-link href=#biblio-css3val></a>[CSS3VAL]<dd>Håkon Wium Lie; Tab Atkins; Elika J. Etemad. <a href=http://www.w3.org/TR/2013/CR-css3-values-20130730/>CSS Values and Units Module Level 3</a>. 30 July 2013. W3C Candidate Recommendation. (Work in progress.) URL: <a href=http://www.w3.org/TR/2013/CR-css3-values-20130730/>http://www.w3.org/TR/2013/CR-css3-values-20130730/</a><dt id=biblio-jis4051 title=JIS4051><a class=self-link href=#biblio-jis4051></a>[JIS4051]<dd>???. Formatting rules for Japanese documents (『日本語文書の組版方法』). 2004. In Japanese <dt id=biblio-css3-fonts title=css3-fonts><a class=self-link href=#biblio-css3-fonts></a>[css3-fonts]<dd>John Daggett. <a href=http://www.w3.org/TR/css3-fonts/>CSS Fonts Module Level 3</a>. 11 December 2012. WD. URL: <a href=http://www.w3.org/TR/css3-fonts/>http://www.w3.org/TR/css3-fonts/</a><dt id=biblio-jlreq title=jlreq><a class=self-link href=#biblio-jlreq></a>[jlreq]<dd>Yasuhiro Anan; et al. <a href=http://www.w3.org/TR/jlreq/>Requirements for Japanese Text Layout</a>. 3 April 2012. NOTE. URL: <a href=http://www.w3.org/TR/jlreq/>http://www.w3.org/TR/jlreq/</a><dt id=biblio-ruby title=ruby><a class=self-link href=#biblio-ruby></a>[ruby]<dd>Marcin Sawicki; et al. <a href=http://www.w3.org/TR/ruby/>Ruby Annotation</a>. 31 May 2001. REC. URL: <a href=http://www.w3.org/TR/ruby/>http://www.w3.org/TR/ruby/</a></dl><h2 class="no-num heading settled" id=index><span class=content>Index</span><a class=self-link href=#index></a></h2><ul class=indexlist><li>annotation, <a href=#ruby-annotation-box title="section 2.1">2.1</a><li>annotation level, <a href=#annotation-level title="section 2.3.1">2.3.1</a><li>base level, <a href=#base-level title="section 2.3.1">2.3.1</a><li>collapsed annotation, <a href=#collapsed-annotation title="section 4.2">4.2</a><li>display, <a href=#propdef-display title="section 2.1">2.1</a><li>hidden annotation, <a href=#hidden-ruby-annotation title="section 2.4">2.4</a><li>hidden ruby annotation, <a href=#hidden-ruby-annotation title="section 2.4">2.4</a><li>inter-annotation white space, <a href=#inter-annotation-white-space title="section 2.2">2.2</a><li>inter-base white space, <a href=#inter-base-white-space title="section 2.2">2.2</a><li>inter-character, <a href=#valdef-ruby-position-inter-character title="section 4.1">4.1</a><li>inter-level white space, <a href=#inter-level-white-space title="section 2.2">2.2</a><li>internal ruby boxes, <a href=#internal-ruby-boxes title="section 2.1.1">2.1.1</a><li>internal ruby display types, <a href=#internal-ruby-boxes title="section 2.1.1">2.1.1</a><li>inter-segment white space, <a href=#inter-segment-white-space title="section 2.2">2.2</a><li>intra-level white space, <a href=#intra-level-white-space title="section 2.2">2.2</a><li>intra-ruby white space, <a href=#intra-ruby-white-space title="section 2.2">2.2</a><li>left, <a href=#valdef-ruby-position-left title="section 4.1">4.1</a><li>level, <a href=#annotation-level title="section 2.3.1">2.3.1</a><li>nested ruby, <a href=#nested-ruby title="section 2.3.3">2.3.3</a><li>over, <a href=#valdef-ruby-position-over title="section 4.1">4.1</a><li>pairing, <a href=#pairing title="section 2.3">2.3</a><li>right, <a href=#valdef-ruby-position-right title="section 4.1">4.1</a><li>ruby, <a href=#valdef-display-ruby title="section 2.1">2.1</a><li>Ruby, <a href=#ruby title="section 1.4">1.4</a><li>ruby-align, <a href=#propdef-ruby-align title="section 4.3">4.3</a><li>ruby-align:center, <a href=#valdef-ruby-align-ruby-aligncenter title="section 4.3">4.3</a><li>ruby-align:space-around, <a href=#valdef-ruby-align-ruby-alignspace-around title="section 4.3">4.3</a><li>ruby-align:space-between, <a href=#valdef-ruby-align-ruby-alignspace-between title="section 4.3">4.3</a><li>ruby-align:start, <a href=#valdef-ruby-align-ruby-alignstart title="section 4.3">4.3</a><li>ruby annotation, <a href=#ruby-annotation-box title="section 2.1">2.1</a><li>ruby annotation box, <a href=#ruby-annotation-box title="section 2.1">2.1</a><li>ruby annotation container, <a href=#ruby-annotation-container-box title="section 2.1">2.1</a><li>ruby annotation container box, <a href=#ruby-annotation-container-box title="section 2.1">2.1</a><li>ruby base, <a href=#ruby-base-box title="section 2.1">2.1</a><li>ruby-base, <a href=#valdef-display-ruby-base title="section 2.1">2.1</a><li>ruby base box, <a href=#ruby-base-box title="section 2.1">2.1</a><li>ruby base container, <a href=#ruby-base-container-box title="section 2.1">2.1</a><li>ruby-base-container, <a href=#valdef-display-ruby-base-container title="section 2.1">2.1</a><li>ruby base container box, <a href=#ruby-base-container-box title="section 2.1">2.1</a><li>ruby container, <a href=#ruby-container title="section 2.1">2.1</a><li>ruby container box, <a href=#ruby-container title="section 2.1">2.1</a><li>ruby formatting context, <a href=#ruby-formatting-context title="section 2.1.1">2.1.1</a><li>ruby-merge, <a href=#propdef-ruby-merge title="section 4.2">4.2</a><li>ruby-merge:auto, <a href=#valdef-ruby-merge-ruby-mergeauto title="section 4.2">4.2</a><li>ruby-merge:collapse, <a href=#valdef-ruby-merge-ruby-mergecollapse title="section 4.2">4.2</a><li>ruby-merge:separate, <a href=#valdef-ruby-merge-ruby-mergeseparate title="section 4.2">4.2</a><li>ruby-position, <a href=#propdef-ruby-position title="section 4.1">4.1</a><li>ruby segments, <a href=#ruby-segments title="section 2.3.1">2.3.1</a><li>ruby-text, <a href=#valdef-display-ruby-text title="section 2.1">2.1</a><li>ruby-text-container, <a href=#valdef-display-ruby-text-container title="section 2.1">2.1</a><li>span, <a href=#span title="section 2.3">2.3</a><li>spanning annotation, <a href=#spanning-annotation title="section 2.3">2.3</a><li>under, <a href=#valdef-ruby-position-under title="section 4.1">4.1</a></ul><h2 class="no-num heading settled" id=property-index><span class=content>Property Index</span><a class=self-link href=#property-index></a></h2><table class="proptable data"><thead><tr><th scope=col>Name<th scope=col>Value<th scope=col>Initial<th scope=col>Applies to<th scope=col>Inh.<th scope=col>%ages<th scope=col>Media<th scope=col>Animatable<th scope=col>Canonical order<th scope=col>Computed value<th scope=col>New values<tbody><tr><th scope=row><a class=css data-link-type=property href=#propdef-display title=display>display</a><td><td><td><td><td><td><td><td><td><td>ruby | ruby-base | ruby-text | ruby-base-container | ruby-text-container<tr><th scope=row><a class=css data-link-type=property href=#propdef-ruby-position title=ruby-position>ruby-position</a><td>[ over | under | inter-character ] &amp;&amp; [ right | left ]<td>over right<td>ruby annotation containers<td>yes<td>N/A<td>visual<td>no<td>per grammar<td>specified value<td><tr><th scope=row><a class=css data-link-type=property href=#propdef-ruby-merge title=ruby-merge>ruby-merge</a><td>separate | collapse | auto<td>separate<td>ruby annotation containers<td>yes<td>N/A<td>visual<td>no<td>per grammar<td>specified value<td><tr><th scope=row><a class=css data-link-type=property href=#propdef-ruby-align title=ruby-align>ruby-align</a><td>start | center | space-between | space-around<td>space-around<td>ruby bases, ruby annotations, ruby base containers, ruby annotation containers<td>yes<td>N/A<td>visual<td><td><td>specified value (except for initial and inherit)<td></table><h2 class="no-num heading settled" id=issues-index><span class=content>Issues Index</span><a class=self-link href=#issues-index></a></h2><div style=counter-reset:issue><div class=issue>Are internal ruby boxes inline-level?

<a href=#issue-ca88244c> ↵ </a></div><div class=issue>The goal of this is to simplify the layout model by suppressing any line breaks within ruby annotations.
			Alternatively we could try to define some kind of acceptable behavior for them.

		<a href=#issue-8af70305> ↵ </a></div><div class=issue>Make <a href=http://lists.w3.org/Archives/Public/www-archive/2014Jun/att-0027/PastedGraphic-1.png>this diagram</a> into an example.

	<a href=#issue-778a7acd> ↵ </a></div><div class=issue>Insert diagram<a href=#issue-0230a91a> ↵ </a></div><div class=issue>It’s not clear whether this falls out of layout handling of ruby containers inside ruby bases
	or needs to be handled specially.
	Waiting until layout is better-defined to find out...

<a href=#issue-9b177ca3> ↵ </a></div><div class=issue>Or should it become a quasi-base between two bases?<a href=#issue-029133da> ↵ </a></div><div class=issue>
	Insert scanned example so people don’t think this is just the ramblings of an insane spec-writer.

	<a href=#issue-14d7c6b1> ↵ </a></div><div class=issue><span class=issuehead>Issue-107: </span> Roland Steiner has requested the addition of an auto value as default. See <a href="http://www.w3.org/Search/Mail/Public/advanced_search?keywords=&amp;hdr-1-name=subject&amp;hdr-1-query=ruby-position%3A+undesirable+default+value+%27before%27+for+complex+ruby&amp;hdr-2-name=from&amp;hdr-2-query=&amp;hdr-3-name=message-id&amp;hdr-3-query=&amp;period_month=&amp;period_year=&amp;index-grp=Public__FULL&amp;index-type=t&amp;type-index=www-style&amp;resultsperpage=20&amp;sortby=date">this thread</a> and <a href="http://www.w3.org/Search/Mail/Public/advanced_search?keywords=&amp;hdr-1-name=subject&amp;hdr-1-query=Styling+of+complex+Ruby&amp;hdr-2-name=from&amp;hdr-2-query=&amp;hdr-3-name=message-id&amp;hdr-3-query=&amp;period_month=&amp;period_year=&amp;index-grp=Public__FULL&amp;index-type=t&amp;type-index=public-i18n-core&amp;resultsperpage=20&amp;sortby=date">this one</a>.<a href=#issue-8b54b949> ↵ </a></div><div class=issue>Add a paragraph explaining how to distribute space in situations with spanning annotations.

<a href=#issue-c66abaa7> ↵ </a></div><div class=issue>
		I suspect overhanging interacts with alignment in some cases;
		might need to look into this later.

	<a href=#issue-9258d5ed> ↵ </a></div></div>